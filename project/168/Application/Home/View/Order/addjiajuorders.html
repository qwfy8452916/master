<extend name="Main:baseTemplate"/>
<block name="meta">
    <title>新后台发单入口</title>
</block>
<block name="style">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/order/css/getorder.css?v={:C('STATIC_VERSION')}">
</block>

<block name="content">
    <section class="content-header">
        <h1>新增家具发单</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="/order/">订单查询</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-body">
                        <div class="row">
                            <form class="form-horizontal">
                                <ul>
                                    <li class="input"><label><span style="color:red;">*</span>订单来源：</label>
                                        <select name="orderfrom" id="categoryid" class="select_type orderfrom">
                                            <option value="">-请选择订单来源-</option>
                                            <option value="1"
                                            <if condition="$list['source_type'] == 1">selected</if>
                                            >53客服</option>
                                            <option value="2"
                                            <if condition="$list['source_type'] == 2">selected</if>
                                            >400电话</option>
                                            <option value="3"
                                            <if condition="$list['source_type'] == 3">selected</if>
                                            >QQ咨询</option>
                                            <option value="11"
                                            <if condition="$list['source_type'] == 11">selected</if>
                                            >推广部</option>
                                            <option value="5"
                                            <if condition="$list['source_type'] == 5">selected</if>
                                            >其他</option>
                                        </select>
                                    </li>
                                    <li class="input kefu"><label><span style="color:red;">*</span>渠道来源：</label>
                                        <select name="ordersource" id="source" class="select_type ordersourcekefu">
                                            <option value="">-请选择渠道来源-</option>
                                            <option value="1">客服发单</option>
                                            <option value="2">其他</option>
                                        </select>
                                    </li>
                                    <li class="input">
                                        <div style="display: inline-block;">
                                            <div class="firstdiv"><span style="color:red;">*</span>联系电话：</div>
                                            <input name="mobile" class="mobilemain select_type" id="mobile" type="text"
                                                   value="{$list.tel|default=''}" maxlength="11"
                                                   style="width:150px;"
                                            <if condition="isset($_GET['id'])">disabled</if>
                                            >
                                            <span id="checkPhone" style="font-size: 18px"></span>
                                        </div>
                                        <div style="display: inline-block;">
                                            <div class="firstdiv">备用联系：</div>
                                            <input name="secoundmobile" id="secoundmobile" type="text"
                                                   value="{$list.other_contact|default=''}"
                                                   style="width:150px;" class="select_type secoundmobile">
                                        </div>
                                    </li>
                                    <li class="input">
                                        <div style="display: inline-block;">
                                            <div class="firstdiv"><span style="color:red;">*</span>联系人：</div>
                                            <input name="name" id="name" type="text" value="{$list.name|default=''}" autocomplete="off"
                                                   style="width:150px;"
                                                   class="select_type name">
                                        </div>
                                        <div style="display: inline-block;">
                                            <label>性别：</label>
                                            <select name="sex" id="sex" class="select_type sex"
                                                    style="width: 150px">
                                                <option value="">-请选择联系人性别-</option>
                                                <option value="女士"
                                                <if condition="$list['sex'] == '女士'">selected</if>
                                                >女士</option>
                                                <option value="先生"
                                                <if condition="$list['sex'] == '先生'">selected</if>
                                                >先生</option>
                                            </select>
                                        </div>
                                    </li>
                                    <li class="input">
                                        <div style="display: inline-block;">
                                            <label><span style="color:red;">*</span>选择城市：</label>
                                            <select name="cs" class="select_type cs" id="cs" style="width:150px;"
                                            <if condition="isset($_GET['id'])">disabled</if>
                                            >
                                            <option value="">-请选择-</option>
                                            <volist name="city" id="vo">
                                                <option value="{$vo.cid}"
                                                <if condition="$vo['cid'] == $list['cs']">selected</if>
                                                >{$vo.char_name}</option>
                                            </volist>
                                            </select>
                                        </div>
                                        <div style="display: inline-block;">
                                            <label for="qy">选择区县：</label>
                                            <select name="qy" class="select_type qy" id="qy" style="width:150px;"
                                            <if condition="isset($_GET['id'])">disabled</if>
                                            >
                                            <volist name="quyu" id="vo">
                                                <option value="{$vo.qz_areaid}"
                                                <if condition="$vo['qz_areaid'] EQ $list['qx']">selected</if>
                                                >{$vo.qz_area}</option>
                                            </volist>
                                            </select>
                                        </div>
                                        <div style="display: inline-block;">
                                            <div class="firstdiv"><span style="color:red;">*</span>小区名称：</div>
                                            <input name="xiaoqu" id="xiaoqu" type="text"
                                                   value="{$list.xiaoqu|default=''}"
                                                   class="select_type xiaoqu">
                                        </div>
                                        <div style="display: inline-block;">
                                            <div class="firstdiv">小区地址：</div>
                                            <input name="dizhi" id="dizhi" type="text" value="{$list.dz|default=''}"
                                                   class="select_type dizhi">
                                        </div>
                                    </li>
                                    <li class="input">
                                        <label>装修类型：</label>
                                        <select name="lx" class="select_type lx" style="width:150px;">
                                            <option value="">-请选择装修类型-</option>
                                            <option value="1"
                                            <if condition="$list['lx'] == 1">selected</if>
                                            >家装</option>
                                            <option value="2"
                                            <if condition="$list['lx'] == 2">selected</if>
                                            >公装</option>
                                        </select>
                                        <div style="display: inline-block;">
                                            <div class="firstdiv">用途：</div>
                                            <input name="yt" id="yt" type="text" value="{$list.yt|default=''}"
                                                   style="width:150px;"
                                                   class="select_type yt">
                                        </div>
                                        <div style="display: inline-block;">
                                            <label>装修进度：</label>
                                            <select name="step" class="select_type step" style="width:150px;">
                                                <option value="">-请选择装修进度-</option>
                                                <option value="1"
                                                <if condition="$list['step'] == 1">selected</if>
                                                >未施工</option>
                                                <option value="2"
                                                <if condition="$list['step'] == 2">selected</if>
                                                >施工中</option>
                                                <option value="3"
                                                <if condition="$list['step'] == 3">selected</if>
                                                >已完工</option>
                                            </select>
                                        </div>
                                    </li>
                                    <li class="input">
                                        <label><span style="color: red;">*</span>户型结构：</label>
                                        <select name="huxing" class="select_type huxing" style="width:150px;">
                                            <option value="">-请选择-</option>
                                            <volist name="info.hx" id="hx">
                                                <option value="{$hx.id}"
                                                <if condition="$list['huxing'] == $hx['id']">selected</if>
                                                >{$hx.name}</option>
                                            </volist>
                                        </select>
                                        <div style="display: inline-block;">
                                            <div class="firstdiv">面积：</div>
                                            <input name="mianji" id="mianji" type="text"
                                                   value="{$list.mianji|default=''}" style="width:150px;"
                                                   class="select_type mianji"> <span>m<sup>2</sup></span>
                                        </div>
                                    </li>
                                    <li class="input">
                                        <label><span style="color: red;">*</span>家具风格：</label>
                                        <select name="fengge" class="fengge" style="width: 150px">
                                            <option value="">-请选择风格-</option>
                                            <volist name="info.fg" id="fg">
                                                <option value="{$fg.id}"
                                                <if condition="$list['fengge'] == $fg['id']">selected</if>
                                                >{$fg.name}</option>
                                            </volist>
                                        </select>
                                        <div style="display: inline-block;">
                                            <label>到店时间：</label>
                                            <select name="view_time" class="select_type view_time" style="width:150px;">
                                                <option value="">-业主可到店时间-</option>
                                                <option value="随时"
                                                <if condition="$list['view_time'] == '随时'">selected</if>
                                                >随时</option>
                                                <option value="3天内"
                                                <if condition="$list['view_time'] == '3天内'">selected</if>
                                                >三天</option>
                                                <option value="1周内"
                                                <if condition="$list['view_time'] == '1周内'">selected</if>
                                                >一周内</option>
                                                <option value="2周内"
                                                <if condition="$list['view_time'] == '2周内'">selected</if>
                                                >二周内</option>
                                                <option value="1个月内"
                                                <if condition="$list['view_time'] == '1个月内'">selected</if>
                                                >一个月内</option>
                                            </select>
                                        </div>
                                    </li>
                                    <li class="input">
                                        <label><span style="color:red;">*</span>家具预算：</label>
                                        <select name="yusuan" class="yusuan" style="width: 150px">
                                            <option value="">未选择</option>
                                            <volist name="info.jg" id="ys">
                                                <option value="{$ys.id}"
                                                <if condition="$list['yusuan'] == $ys['id']">selected</if>
                                                >{$ys.name}</option>
                                            </volist>
                                        </select>
                                    </li>
                                    <li class="input">
                                        <div style="display: inline-block; vertical-align: middle">
                                            <label><span style="color: red;">*</span>家具类型：</label>
                                            <select class="select_type jjlx furniture-type" name="furniture_type"
                                                    style="width:150px;">
                                                <option value="">请选择</option>
                                                <option value="全屋定制"
                                                <if condition="$list['furniture_type'] == '全屋定制'">selected</if>
                                                >全屋定制</option>
                                                <option value="全屋采购"
                                                <if condition="$list['furniture_type'] == '全屋采购'">selected</if>
                                                >全屋采购</option>
                                                <option value="不限"
                                                <if condition="$list['furniture_type'] == '不限'">selected</if>
                                                >不限</option>
                                            </select>
                                        </div>
                                        <div style="display: inline-block;opacity: 0; vertical-align: middle"
                                             class="furniture-choice">
                                            <label for="bed"><input type="checkbox" id="bed" name="furniture_type_child"
                                                                    value="床"
                                                <if condition="stripos($list['furniture_type_child'],'床')!== false">
                                                    checked
                                                </if>
                                                >床</label>
                                            <label for="sofa"><input type="checkbox" id="sofa"
                                                                     name="furniture_type_child" value="沙发"
                                                <if condition="stripos($list['furniture_type_child'],'沙发')!== false">
                                                    checked
                                                </if>
                                                >沙发</label>
                                            <label for="dining-table"><input type="checkbox" id="dining-table"
                                                                             name="furniture_type_child" value="餐桌"
                                                <if condition="stripos($list['furniture_type_child'],'餐桌')!== false">
                                                    checked
                                                </if>
                                                >餐桌</label>
                                            <label for="wardrobe"><input type="checkbox" id="wardrobe"
                                                                         name="furniture_type_child" value="衣柜"
                                                <if condition="stripos($list['furniture_type_child'],'衣柜')!== false">
                                                    checked
                                                </if>
                                                >衣柜</label>
                                            <label for="others"><input type="checkbox" id="others"
                                                                       name="furniture_type_child" value="其他"
                                                <if condition="stripos($list['furniture_type_child'],'其他')!== false">
                                                    checked
                                                </if>
                                                >其他</label>
                                        </div>
                                    </li>
                                    <li class="input">
                                        <label>家具需求：</label>
                                        <textarea name="special_remarks" id="special_remarks" placeholder="补充描述"
                                                  maxlength="150"
                                                  style="height:100px;width:450px;"
                                                  class="form-control special_remarks">{$list.special_remarks|default=''}</textarea><br>
                                        <span id="contentCount"
                                              style="padding-left:90px;margin-top:10px;">还可以输入 <em>150</em>  字</span>
                                    </li>
                                    <li class="input">
                                        <div style="display: inline-block;">
                                            <label>提交人：</label>
                                            <input type="text" class="select_type" name="tjname" value="{$user.name}"
                                                   disabled="disabled">
                                            <input type="hidden" class="tjid" name="tjid" value="{$user.id}">
                                        </div>
                                    </li>
                                    <li class="input" style=" margin-left: 206px;">
                                        <input type="hidden" name="edit_id" class="edit_id"
                                               value="{$_GET['id']|default=''}">
                                        <a id="submit" href="javascript:void (0);" class="btn btn-success button">确定</a>
                                    </li>
                                </ul>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


</block>

<block name="script">
    <script>
        $(function () {
            //*家具类型
            var furniture_type = '{$list.furniture_type|default=""}';
            if (furniture_type == '不限') {
                $(".furniture-choice").css('opacity', 1);
            }
        });
        var reg = RegExp("^((13[0-9])|(14[0-9])|(15[0-9])|(17[0-9])|(18[0-9])|166|198|199|(147))\\d{8}$")
        //提交
        $('#submit').on('click', function () {
            var data = new Object();
            data.edit_id = $(".edit_id").val();//编辑id
            var orderfrom = $('.orderfrom').val();
            if (orderfrom == '') {
                alert('请选择订单来源');
                return false
            }
            data.orderfrom = orderfrom;//订单来源
            var ordersourcekefu = $('.ordersourcekefu').val();
            if (ordersourcekefu == '') {
                alert('请选择渠道来源');
                return false
            }
            data.source = ordersourcekefu;
            //如果编辑 , 不验证手机号
            if (!data.edit_id) {
                var mobilemain = $('.mobilemain').val().trim();
                if (mobilemain == '') {
                    alert('请填写联系电话')
                    return false
                } else {
                    if (!reg.test(mobilemain)) {
                        alert('请输入正确手机号')
                        return false
                    }
                }
            }
            data.mobilemain = mobilemain;//联系电话
            data.secoundmobile = $('.secoundmobile').val();//备用电话
            var name = $('.name').val().trim();
            if (name == '') {
                alert('请填写联系人名称');
                return false
            }
            data.name = name;//联系人
            data.sex = $('.sex').val();//性别
            var cs = $('.cs').val();
            var qy = $('.qy').val();
            if (cs == '000001'||cs=='' || qy == '' || qy == '-请选择区域-') {
                alert("请选择城市区县信息！");
                return false;
            }
            data.cs = cs;//城市
            data.qy = qy;//区县

            var xiaoqu = $('.xiaoqu').val().trim();
            if (xiaoqu == '') {
                alert("请填写小区名称！");
                return false;
            }
            data.xiaoqu = xiaoqu;//小区
            data.dizhi = $('.dizhi').val();//地址
            var huxing = $('.huxing').val();
            if (huxing == '') {
                alert('请选择户型结构');
                return false;
            }
            data.huxing = huxing;//户型
            data.lx = $('.lx').val();//装修类型
            data.yt = $('.yt').val();//用途
            data.step = $('.step').val();//装修进度
            data.mianji = $('.mianji').val();//面积
            var fengge = $('.fengge').val();
            if (fengge == '') {
                alert('请选择家具风格');
                return false
            }
            data.fengge = fengge;//风格
            data.view_time = $('.view_time').val();//到店时间
            var yusuan = $('.yusuan').val();
            if (yusuan == '') {
                alert('请填写家具预算')
                return false
            }
            data.yusuan = yusuan;//预算

            var jjlx = $('.jjlx').val();
            if (jjlx == '') {
                alert('请选择家具类型')
                return false
            }
            if (jjlx == '不限') {
                var brr = [];
                $("input[type=checkbox]").each(function () {
                    if ($(this).is(":checked")) {
                        brr.push($(this).val())
                    }
                });
                if (brr.length == 0) {
                    data.furniture_type_child = '其他';
                } else {
                    data.furniture_type_child = brr;
                }
            }
            data.jjlx = jjlx;//家具类型
            data.special_remarks = $(".special_remarks").val();//家具需求
            data.adminuser = $(".tjid").val();//提交人

            $.ajax({
                url: '/order/saveJiajuOrder',
                type: 'POST',
                dataType: 'JSON',
                data: data,
                success: function (data) {
                    alert(data.info);
                    if (data.status == 1) {
                        $(this).bind("click");
                        window.location.href = window.location.href;
                    } else {
                        $(this).bind("click");
                    }
                },
                error: function (xhr) {
                    alert("网络不稳定，请重试！");
                }
            });
        })
        //限制描述
        $('#special_remarks').bind('input propertychange', function () {
            var length = $(this).val().length;
            if (length > 150) {
                var offset = length - 150;
                $('#contentCount').html('<i class="red">您已经超出了 ' + offset + " 字</i>")
            } else {
                var offset = 150 - length;
                $('#contentCount em').html(offset)
            }
        })
        var furniture_type = '{$info.furniture_type|default=""}';
        if (furniture_type == '不限') {
            $(".furniture-choice").css('opacity', 1);
        }
        $('.furniture-type').change(function () {
            if ($('.furniture-type').val() == '不限') {
                $(".furniture-choice").css('opacity', 1)
            } else {
                $(".furniture-choice").css("opacity", 0)
                $("input[type=checkbox]").attr("checked", false)
            }
        });

        //修改城市，ajax获取城市对应的区域以及装修公司的信息
        $('select[name=cs]').change(function (event) {
            var cid = $(this).val();
            $.ajax({
                url: '/orders/getareabycid/',
                type: 'GET',
                dataType: 'JSON',
                data: {
                    cid: cid
                }
            })
                .done(function (data) {
                    if (data.status == 1) {
                        $('select[name=qy]').html(data.data.area);
                    } else {
                        alert(data.errmsg || data.info);
                    }
                });
        });
    </script>
</block>
