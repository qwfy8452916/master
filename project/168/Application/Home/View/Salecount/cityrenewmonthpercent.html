<extend name="Main:baseTemplate" />
<block name="title">
	<title>城市续费月数完成率 - 控制台</title>
</block>
<block name="style">
	<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
	<link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
	<link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
	<link rel="stylesheet" type="text/css" href="/assets/home/css/xs-gangwei.css?v={:C('STATIC_VERSION')}">
</block>
<block name="content">
    <div class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="overflow-x">
                        <div class="overflow-box" style="width: 1580px">
                            <div class="box-header">
                                <h3><i class="xs-icon csxfl-icon"></i>城市续费月数完成率</h3>
                                <form class="form-horizontal">
                                    <div class="from-list">
                                        <style>
                                            .select2-container{width: 130px;vertical-align: middle;}
                                            .select2-choice{height: auto !important;line-height: 17px !important;}
                                            .select2-container .select2-choice div b{background-position: 0 0 !important;}
                                            .from-list .from-item span {text-align: left;}
                                            .search-btn{margin-top: 0px;}
                                            table tbody input[type="text"] {width:50px;}
                                            .blk {display: inline-block;}
                                            table tbody tr td i.fa{font-size: 14px !important;margin-left: 2px;margin-right: 0 !important;}
                                        </style>
                                        <div class="blk">
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">部门：</span>
                                                <select id="department" class="select2 select2-offscree pull-left" name="department" type="text">
                                                    <switch name="department">
                                                        <case value="0">
                                                            <option value="">请选择</option>
                                                            <option value="1">商务</option>
                                                            <option value="2">外销</option>
                                                        </case>
                                                        <case value="1">
                                                            <option value="">请选择</option>
                                                            <option value="1">商务</option>
                                                        </case>
                                                        <case value="2">
                                                            <option value="">请选择</option>
                                                            <option value="2">外销</option>
                                                        </case>
                                                    </switch>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">品师长：</span>
                                                <select id="pshizhang" name="pshizhang" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.brand_division" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">品团长：</span>
                                                <select id="ptuanzhang" name="ptuanzhang" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.brand_regiment" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">品牌师&nbsp;&nbsp;&nbsp;&nbsp;：</span>
                                                <select id="pinpai" name="pinpai" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.brand_manage" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="blk">
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">城市：</span>
                                                <select id="city" name="city" class="select2 select2-offscree pull-left">
                                                    <option value="">所属城市</option>
                                                    <volist name="citys" id="vo">
                                                        <option value="{$vo.city}">{$vo.city}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">拓师长：</span>
                                                <select id="tshizhang" name="tshizhang" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.dev_division" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">拓团长：</span>
                                                <select id="ttuanzhang" name="ttuanzhang" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.dev_regiment" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto;float: left;line-height: 25px;">城市经理：</span>
                                                <select id="csjl" name="csjl" class="select2 select2-offscree pull-left">
                                                    <option value="">全部</option>
                                                    <volist name="brand.dev_manage" id="vo">
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                    </volist>
                                                </select>
                                            </div>
                                            <div class="from-item">
                                                <span style="width: auto">查询月份：</span>
                                                <input id="time" class="datepicker" type="text" name="time" placeholder="选择日期" value="{$keyword.time}">
                                            </div>
                                            <div class="from-item"><button class="search-btn xs-btn">查询</button></div>
                                        </div>
                                    </div>
                                </form>
                                <div class="select-role-input">显示：
                                    品师长<input type="checkbox" value="品师长">
                                    品团长<input type="checkbox" value="品团长">
                                    品牌师<input type="checkbox" value="品牌师">
                                    拓师长<input type="checkbox" value="拓师长">
                                    拓团长<input type="checkbox" value="拓团长">
                                    城市经理<input type="checkbox" value="城市经理">
                                </div>
                            </div>
                            <div class="box-body">
                                <div class="todo-item">
                                    <div class="pull-right position-relative">
                                        <a href="/salesetting/downloadmodule?type=14&data=1" style="color: #FFF;"><button class="xs-btn hideLoading">导出</button></a>
                                        <i class="xs-icon zhushi-icon"></i>
                                        <div class="zhushi-info">
                                            <p>输入人注意事项：本页数据以城市为唯一标识，其他数据均为附属信息</p>
                                            <p><span class="redcolor">默认显示数据为</span>：城市重点系数降序排列，+置顶（鼠标悬浮在记录的城市上方时显示置顶按钮，点击置顶，则记录显示在首页的第一条）</p>
                                            <p>名词解释：（当月的数据：当月1日凌晨0.10到当日凌晨0:10，之前月数据：统计当月1日凌晨0.10到次月1日凌晨0：10）</p>
                                            <p>所有百分比类型的是指全部为：XX.X%，即取值小数点后1位，比如：90.17%取值90.2%，90.14%取值90.1%四舍五入，90%取值90.0%。</p>
                                            <p>数值为小数点后1位的（四舍五入）：到期数指标、超出会员数</p>
                                            <p>数值为整数的：到期数、实际续费数</p>
                                            <p>1、部门：城市归属部门，外销、商务城市“续费率指标、全年续费率均值、续费率最高值、月度系数”读取《部门续费月度系数》的对应值</p>
                                            <p>2、到期数：会员本次合同结束日在当月的所有会员的合计数量。</p>
                                            <p>3、到期数指标：根据相应的部门计算，（城市到期数*城市到期数指标系数）值。</p>
                                            <p>4、实际续费数：统计的当月1日凌晨0：10-次月1日凌晨0：10续费会员数量（单倍会员数+多倍会员数*多倍）的总和。营销中心为外销+商务的总和。</p>
                                            <p>5、续费率：合计实际续费数/合计到期数*100%</p>
                                            <p>6、续费率达成：续费率/续费率指标*100%</p>
                                            <p>7、系数后续费率：续费率/续费率月度系数。</p>
                                            <p>8、超出会员数：（续费率-续费率指标）*到期数，≤0的情况下均为0</p>
                                            <p>9、城市到期数指标系数：以（5）为准，（1）当城市月单价≥3000元/月，到期数指标系数为1，（2）当月单价＜3000元/月，城市到期数指标系数=城市月单价/3000元/月*1，（该城市月单价/＜3000元/<p>月*1。（3）月单价=季度收款单价/3个月。（4）以最新调价为准，如遇月中改价，按照次月1日开始计算。（5）因单价暂不输入系统，故城市续费月数指标系数，全部系数值有管理员导入。</p>
                                            <p>10、新签：根据会员ID号取值，本次合同开始日与上次合作的本次合同结束日间隔天数，间隔天数＞180天，或无合作过的会员属于新签</p>
                                            <p>11、续费：根据会员ID号取值，本次合同开始日与上次合作的本次合同结束日间隔天数，间隔天数≤180天的会员属于续费</p>
                                            <p>12、当月数据显示：以当月1日凌晨0.10到当日凌晨0:10的数值显示，比如4月16日当天数据显示为4月1日凌晨0：10到4月16日凌晨0：10的数值，分析折线图不显示4月数值。</p>
                                            <p>13、所有统计数值，取次月1日凌晨0：10的数值定格保存。</p>
                                        </div>
                                    </div>
                                </div>
                                <table id="reset-table" class="table table-bordered table-hover dataTable no-footer" role="grid" >
                                    <thead class="thead1" style="width: 1580px>
                                        <tr role="row">
                                            <th title="城市">城市</th>
                                            <th title="部门">部门</th>
                                            <th class="role-hide" title="品师长">品师长</th>
                                            <th class="role-hide" title="品团长">品团长</th>
                                            <th class="role-hide" title="品牌师">品牌师</th>
                                            <th class="role-hide" title="拓师长">拓师长</th>
                                            <th class="role-hide" title="拓团长">拓团长</th>
                                            <th class="role-hide" title="城市经理">城市经理</th>
                                            <th title="到期数">到期数</th>
                                            <th title="续费月数指标">续费月数指标</th>
                                            <th title="实际续费月数">实际续费月数</th>
                                            <th title="续费月数完成率">续费月数完成率</th>
                                            <th title="续费月数完成率指标">续费月数完成率指标</th>
                                            <th title="续费月数完成率达成">续费月数完成率达成</th>
                                            <th title="全年续费月数完成率均值">全年续费月数完成率均值</th>
                                            <th title="系数后续费月数完成率">系数后续费月数完成率</th>
                                            <th title="续费月数完成率封顶值">续费月数完成率封顶值</th>
                                            <th title="超出月数">超出月数</th>
                                        </tr>
                                    </thead>
                                    <thead class="thead2" style="width: 1580px">
                                        <tr role="row">
                                            <th title="城市">城市</th>
                                            <th title="部门">部门</th>
                                            <th class="role-hide" title="品师长">品师长</th>
                                            <th class="role-hide" title="品团长">品团长</th>
                                            <th class="role-hide" title="品牌师">品牌师</th>
                                            <th class="role-hide" title="拓师长">拓师长</th>
                                            <th class="role-hide" title="拓团长">拓团长</th>
                                            <th class="role-hide" title="城市经理">城市经理</th>
                                            <th title="到期数">到期数</th>
                                            <th title="续费月数指标">续费月数指标</th>
                                            <th title="实际续费月数">实际续费月数</th>
                                            <th title="续费月数完成率">续费月数完成率</th>
                                            <th title="续费月数完成率指标">续费月数完成率指标</th>
                                            <th title="续费月数完成率达成">续费月数完成率达成</th>
                                            <th title="全年续费月数完成率均值">全年续费月数完成率均值</th>
                                            <th title="系数后续费月数完成率">系数后续费月数完成率</th>
                                            <th title="续费月数完成率封顶值">续费月数完成率封顶值</th>
                                            <th title="超出月数">超出月数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <volist name="list" id="v">
                                            <tr role="row" class="odd">
                                                <td><span>{$v.city}</span><i class="fa fa-arrow-up paixu" title="置顶" data-id="{$v.id}"></i></td>
                                                <td><span>{$v.department}</span></td>
                                                <td class="role-hide"><span>{$v.brand_division|getSaleUserName}</span></td>
                                                <td class="role-hide"><span>{$v.brand_regiment|getSaleUserName}</span></td>
                                                <td class="role-hide"><span>{$v.brand_manage|getSaleUserName}</span></td>
                                                <td class="role-hide"><span>{$v.dev_division|getSaleUserName}</span></td>
                                                <td class="role-hide"><span>{$v.dev_regiment|getSaleUserName}</span></td>
                                                <td class="role-hide"><span>{$v.dev_manage|getSaleUserName}</span></td>
                                                <td><span>{:number_format($v['daoqi'],0,'.','')}</span></td>
                                                <td><span>{:number_format($v['renew_month_point'],1,'.','')}</span></td>
                                                <td><span>{:number_format($v['renew_month'],1,'.','')}</span></td>
                                                <td><span>{$v.renew_month_rate}</span></td>
                                                <td><span>{$v.renew_month_rate_point}</span></td>
                                                <td><span>{$v.renew_month_rate_complete}</span></td>
                                                <td><span>{$v.renew_year_value}</span></td>
                                                <td><span>{$v.renew_monthly_rate}</span></td>
                                                <td><span>{$v.renew_max}</span></td>
                                                <td><span>{:number_format($v['over_month'],1,'.','')}</span></td>
                                            </tr>
                                        </volist>
                                        <tr role="row" class="odd">
                                            <td><span>{$heji.city|default='本页合计'}</span></td>
                                            <td><span>{$heji.department}</span></td>
                                            <td class="role-hide"><span>{$heji.brand_division|default='-'}</span></td>
                                            <td class="role-hide"><span>{$heji.brand_regiment|default='-'}</span></td>
                                            <td class="role-hide"><span>{$heji.brand_manage|default='-'}</span></td>
                                            <td class="role-hide"><span>{$heji.dev_division|default='-'}</span></td>
                                            <td class="role-hide"><span>{$heji.dev_regiment|default='-'}</span></td>
                                            <td class="role-hide"><span>{$heji.dev_manage|default='-'}</span></td>
                                            <td><span>{:number_format($heji['daoqi'],0,'.','')}</span></td>
                                            <td><span>{:number_format($heji['renew_month_point'],1,'.','')}</span></td>
                                            <td><span>{:number_format($heji['renew_month'],1,'.','')}</span></td>
                                            <td><span>{$heji.renew_month_rate}%</span></td>
                                            <td><span>{$heji.renew_month_rate_point}%</span></td>
                                            <td><span>{$heji.renew_month_rate_complete}%</span></td>
                                            <td><span>{$heji.renew_year_value}%</span></td>
                                            <td><span>{$heji.renew_monthly_rate}</span></td>
                                            <td><span>{$heji.renew_max}%</span></td>
                                            <td><span>{:number_format($heji['over_month'],1,'.','')}</span></td>
                                        </tr>
                                        <tr role="row" class="odd">
                                            <td><span>{$total.city|default='本项合计'}</span></td>
                                            <td><span>{$total.department}</span></td>
                                            <td class="role-hide"><span>{$total.brand_division|default='-'}</span></td>
                                            <td class="role-hide"><span>{$total.brand_regiment|default='-'}</span></td>
                                            <td class="role-hide"><span>{$total.brand_manage|default='-'}</span></td>
                                            <td class="role-hide"><span>{$total.dev_division|default='-'}</span></td>
                                            <td class="role-hide"><span>{$total.dev_regiment|default='-'}</span></td>
                                            <td class="role-hide"><span>{$total.dev_manage|default='-'}</span></td>
                                            <td><span>{:number_format($total['daoqi'],0,'.','')}</span></td>
                                            <td><span>{:number_format($total['renew_month_point'],1,'.','')}</span></td>
                                            <td><span>{:number_format($total['renew_month'],1,'.','')}</span></td>
                                            <td><span>{$total.renew_month_rate}%</span></td>
                                            <td><span>{$total.renew_month_rate_point}%</span></td>
                                            <td><span>{$total.renew_month_rate_complete}%</span></td>
                                            <td><span>{$total.renew_year_value}%</span></td>
                                            <td><span>{$total.renew_monthly_rate}</span></td>
                                            <td><span>{$total.renew_max}%</span></td>
                                            <td><span>{:number_format($total['over_month'],1,'.','')}</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="city-list-pop">
                                    <volist name="list" id="v">
                                        <div>{$v.city}</div>
                                    </volist>
                                    <div>本项合计</div>
                                    <div>本页合计</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer text-center"><div>{$page}</div></div>
                </div>

            </div>
        </div>
    </div>
</block>
<block name="script">
	<script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
	<script src="{:C('168NEW_URL')}/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
	<script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
	<script type="text/javascript">
		$(function() {
			$(".select2").select2();
            $("#city").select2("val","{$keyword.city}");
            $("#department").select2("val","{$keyword.department}");
            $("#pshizhang").select2("val","{$keyword.pshizhang}");
            $("#ptuanzhang").select2("val","{$keyword.ptuanzhang}");
            $("#pinpai").select2("val","{$keyword.pinpai}");
            $("#tshizhang").select2("val","{$keyword.tshizhang}");
            $("#ttuanzhang").select2("val","{$keyword.ttuanzhang}");
            $("#csjl").select2("val","{$keyword.csjl}");

			// 时间选择
			$(".datepicker").datetimepicker({
				startView:3,
				minView:'decade',
				format:"yyyy-mm",
				autoclose:true,
				pickerPosition: "bottom-left"
			});
			// 选择城市
			$(".search-city").select2({
				allowClear: true
			});
			// 注释信息
            $('.zhushi-icon').click(function() {
                if($(this).attr('show') == 'show'){
                    $('.zhushi-info').hide();
                    $(this).removeAttr('show')
                }else{
                    $('.zhushi-info').show();
                    $(this).attr('show','show');
                }
            });
            // 竖向滚动时，表格头部悬浮
            var x = null;
            $(document).on('scroll',function(){
                $('.city-list-pop').css({'top':386-$(this).scrollTop()});
                if($(document).scrollTop() >= 321){
                    $('.thead1').show();
                    $('.thead2').css({'position':'fixed','top':0,'left':$('.sidebar').width()+26-x,'z-index':10});
                }else{
                    $('.thead1').hide();
                    $('.thead2').css({'position':'relative',left:0});
                }
            });
            // 横向滚动时，表格头部悬浮
            $('.overflow-x').on('scroll',function(){
                if($(this).scrollLeft()>130){
                    $('.city-list-pop').show();
                }else{
                    $('.city-list-pop').hide();
                }
                x = $(this).scrollLeft();
                $('.thead2').css({'left':$('.sidebar').width()+26-$(this).scrollLeft()});
                $('.city-list-pop').css({'left':$('.sidebar').width()});
            });
            // 岗位选择
            var arr =[0,1,2,3,4,5],
                allheight = 1580,
                selectLen = $('.select-role-input input[show="show"]').length;
            $('.select-role-input input').on('click',function(){
                if($(this).prop('checked')){
                    $(this).attr('show','show');
                    selectLen = $('.select-role-input input[show="show"]').length;
                }else{
                    $(this).removeAttr('show');
                    selectLen = $('.select-role-input input[show="show"]').length;
                }

                $('#reset-table tbody tr').each(function(index, el) {
                    for(var i = 0;i<arr.length;i++){
                        $(el).find('td').eq(arr[i]+2).hide();
                    }
                });
                for(var i = 0;i<arr.length;i++){
                    $('#reset-table .thead1 tr th').eq(arr[i]+2).hide();
                    $('#reset-table .thead2 tr th').eq(arr[i]+2).hide();
                }

                $('.overflow-box,#reset-table .thead1,#reset-table .thead2').width(1580);
                $('.overflow-box,#reset-table .thead1,#reset-table .thead2').width(allheight + selectLen*130);

                $('.select-role-input input[show="show"]').each(function(index, el) {
                    if($(el).val() == '品师长'){
                         autoSelect(2);
                     }else if($(el).val() =='品团长'){
                         autoSelect(3);
                     }else if($(el).val() =='品牌师'){
                         autoSelect(4);
                     }else if($(el).val() =='拓师长'){
                         autoSelect(5);
                     }else if($(el).val() =='拓团长'){
                         autoSelect(6);
                     }else if($(el).val() =='城市经理'){
                         autoSelect(7);
                     }
                });
            });
            function autoSelect(num){
                $('#reset-table .thead1 tr th').eq(num).css('display','block');
                $('#reset-table .thead2 tr th').eq(num).css('display','block');
                $('#reset-table tbody tr').each(function(index, el) {
                    $(el).find('td').eq(num).show();
                });
            }

            //置顶
            $(".paixu").on('click',function(){
                var paixu = $(this).attr('data-id');
                $.ajax({
                    url: '/salesetting/ordernewpaixu/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id : paixu ,
                        type : 6
                    }
                })
                .done(function(data) {
                    if (data.success == 1) {
                        alert('置顶成功，刷新页面后生效！');
                    } else {
                        alert('操作失败，请稍后重试！');
                    }
                })
                .fail(function(xhr){
                    alert(xhr.responseText);
                });
            });
		})
	</script>
</block>