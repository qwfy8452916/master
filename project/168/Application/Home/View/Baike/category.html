<extend name="Main:baseTemplate"/>
<block name="title">
    <title>齐装网百科管理后台 - 控制台</title>
</block>
<block name="style">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/ui-dialog.css?v={:C('STATIC_VERSION')}"/>
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/validation/css/validationEngine.jquery.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/css/meitu.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/css/global-review.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/baike/css/category.css?v={:C('STATIC_VERSION')}">
    <style type="text/css">
        #mainContent {
            width: 85%;
            font-family: "Libre Baskerville", "Lucida Grande", "Hiragino Sans GB", "Hiragino Sans GB W3", "Microsoft YaHei", "wenquanyi micro hei", sans-serif, "Apple Color Emoji";
        }

        .tablebg {
            background: #F3F3F3;
        }

        .table .tableth {
            text-align: left;
        }

        .table .tableCell .input {
            float: left;
            margin: 0 5px;
        }

        .table .tableCell .input input[type=text] {
            width: 300px;
            height: 30px;
            border: 1px solid #c6c6c6;
            padding-left: 5px;
            border-radius: 3px;
        }

        .table .tableCell .input input[type=radio] {
            margin-top: 8px;
        }

        .table .tableCell .input select {
            border: 1px solid #c6c6c6;
            width: 150px;
            padding: 5px;
            border-radius: 3px;
        }

        .table .rowSpan .tableCell {
            border-top: 0;
        }

        .table .tableCell .input textarea {
            width: 455px;
            border: 1px solid #c6c6c6;
            border-radius: 3px;
            padding-left: 2px;
            height: 60px;
            resize: none;
        }

        .table .tableth .span, .table .tableCell .span {
            font-size: 16px;
            font-weight: bold;
            float: left;
            margin-top: 5px;
        }

        .table .tableCell:after {
            content: "";
            clear: both;
            display: block;
        }

        .table .tableCell .button {
            float: left;
            margin-left: 10px;
            width: 100px;
            padding: 4px 12px;
        }

        .table .link_index {
            margin-right: 5px;
        }

        .table .link_index:first-child {
            margin-left: 5px;
        }

        .table .tableCell .link_citys {
            font-weight: normal;
            font-size: 14px;
            margin-right: 5px;
        }

        .table .tableCell .link_input {
            margin: 0;
        }

        .table .tableCell .link_input .span {
            white-space: nowrap;
        }

        .table .tableCell .link_input .span:hover {
            color: #ff0000;
        }

        .table .tableCell .link_active {
            background: #f1f1f1;
        }

        .linkTable td a {
            color: #666;
        }

        .linkTable td a:hover {
            color: #999;
            text-decoration: none;
        }

        .linkTable {
            width: 100%;
            bottom: 1px solid #DDD;
        }

        .linkTable th, .linkTable td {
            text-align: center;
            border-top: 1px solid #DDD;
            padding: 5px 10px;
            border-left: 1px solid #DDD;
        }

        .linkTable th:first-child, .linkTable td:first-child {
            border-left: 0;
        }

        .linkTable td .ico {
            font-size: 16px;
            cursor: pointer;
            margin-right: 5px;
        }

        .linkTable img {
            width: 100px;
            height: 60px;
            cursor: pointer;
        }

        .table .tableCell .link_current {
            font-weight: bold;
            color: #ff0000;
        }

        .input .button {
            float: left;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        .link-error {
            color: #ff0000;
            font-weight: bold;
            padding: 5px;
            float: left;
        }

        #myForm .span {
            float: left;
            margin-top: 5px;
        }

        #myForm .link-error {
            margin-top: 3px;
        }

        textarea {
            resize: none;
        }

        .tags, .item {
            margin: 0;
            padding: 0;
            width: 600px;
            float: left;
            margin-bottom: 10px;
            margin-left: 5px;
        }

        .tags li, .item li {
            float: left;
            padding: 5px;
            border: 1px solid #DDD;
            background: #ECF0F1;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            color: #666;
        }

        .tags li i, .item li i {
            margin-right: 3px;
        }

        .tags .active, .item .active {
            background: #FF8589;
            color: #FFF;
            border: 1px solid #FF8589;
        }

        .link-error {
            color: #ff0000;
            margin-top: 10px;
        }

        li.focus {
            border: 1px solid #FF0000;
        }

        .category .tab-sign {
            display: inline-block;
            margin-left: 15px;
            height: 21px;
            vertical-align: middle;
            background-image: url('/assets/common/img/tab_sign.png');
            background-repeat: no-repeat;
            width: 30px;
            background-position: 0 0;
        }

        .navbar-nav {
            font-size: 16px;
        }
    </style>
</block>

<block name="content">
    <section class="content-header">
        <h1>百科分类管理</h1>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-body">
                        <div class="row">
                            <div class="pull-right col-sm-1">
                                <button class="btn btn-info normal add-category" data-toggle="modal">
                                    <i class="fa fa-plus-circle"></i>新增分类
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-body">
                        <form id="form">
                            <table class="table table-hover">
                                <tbody>
                                <tr>
                                    <th>分类名称</th>
                                    <th>排序</th>
                                    <th>别名</th>
                                    <th>推荐</th>
                                    <th>操作</th>
                                </tr>
                                <volist name="category" id="vo">
                                    <tr>
                                        <td><a href="http://{:C('QZ_YUMINGWWW')}/baike/baikeList/?pid={$vo.cid}" target="_blank">{$vo.name}</a></td>
                                        <td>{$vo.order_id}</td>
                                        <td>{$vo.url}</td>
                                        <td></td>
                                        <td><span title="编辑" class="ico fa fa-pencil edit-category" data-val="{$vo.cid}" data-toggle="modal"></span>
                                            <span title="删除" class="ico fa fa-trash" data-id="{$vo.cid}"></span>
                                        </td>
                                    </tr>
                                    <volist name="vo['sub_cate']" id="v">
                                        <tr>
                                            <td style="text-align:left"><span class="tab-sign"></span>
                                                <a href="http://{:C('QZ_YUMINGWWW')}/baike/baikeList/?cid={$v.cid}" target="_blank">{$v.name}</a>
                                            </td>
                                            <td>{$vo.order_id}-{$v.order_id}</td>
                                            <td>{$v.url}</td>
                                            <!--<td><if condition="$v.is_top eq '1' "><span title="推荐" class="label label-primary ico fa fa-trophy"> </span></if></td>-->
                                            <td>
                                                <a href="javascript:void(0)" data-id="{$v.cid}" <if condition="$v.is_top eq 1">class="fa fa-toggle-on setable set-dist"<else/>class="fa fa-toggle-off setable set-dist"</if>></a>
                                            </td>
                                            <td><span title="编辑" class="ico fa fa-pencil edit-category" data-val="{$v.cid}" data-toggle="modal"></span>
                                                <!--<span title="推荐" class="ico fa fa-trophy set-dist" data-id="{$v.cid}"></span>-->
                                                <span title="删除" class="ico fa fa-trash" data-id="{$v.cid}"></span>
                                            </td>
                                        </tr>
                                    </volist>
                                </volist>
                                </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="box-footer clearfix">
                        <div class="col-xs-12">
                            {$info.info.page}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="edit-category" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="box-body">
                    <form id="edit_category_form">
                        <ul>
                            <li class="input"><label>上级分类：</label>
                                <select name="pid" id="category_id" class="select_type">
                                    <option value="0">一级分类</option>
                                    <volist name="category" id="vo">
                                        <option value="{$vo.cid}">{$vo.name}</option>
                                    </volist>
                                </select>&nbsp;&nbsp;&nbsp;一级分类不能修改为二级分类
                            </li>

                            <li class="input">
                                <label>分类名：</label>
                                <input name="name" type="text" placeholder="分类名" style="width:380px;"
                                       class="form-control">
                            </li>

                            <li class="input">
                                <label>分类URL：</label>
                                <input name="url" type="text" placeholder="分类的链接地址，用拼音。" style="width:380px;"
                                       class="form-control">
                            </li>

                            <li class="input">
                                <label>排序：</label>
                                <input name="order_id" type="text" placeholder="排序" style="width:380px;" class="form-control">
                            </li>
                            <li class="input">
                                <label>title：</label>
                                <textarea name="title" type="text" placeholder="请输入分类的title" style="width:380px;" class="form-control"></textarea>
                            </li>
                            <li class="input">
                                <label>keywords：</label>
                                <textarea name="keywords" type="text" placeholder="请输入分类的keywords" style="width:380px;" class="form-control"></textarea>
                            </li>
                            <li class="input">
                                <label>description：</label>
                                <textarea name="description" type="text" placeholder="请输入分类的description" style="width:380px;" class="form-control"></textarea>
                            </li>
                        </ul>
                        <input type="hidden" name="edit_id"/>
                    </form>
                </div>
                <div class="modal-footer">
                    <span class="btn btn-primary saveBtn">
                        保存
                    </span>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</block>
<block name="script">
    <script type="text/javascript" src="{:C('168NEW_URL')}/assets/common/js/global.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/dialog.min.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript"
            src="{:C('168NEW_URL')}/assets/common/js/plugins/cxselect/jquery.cxselect.min.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        $('.fa-trash').click(function () {
            if (confirm("警告：您确定要删除吗？此操作不可撤销！！")) {
                var id = $(this).attr('data-id');
                if (id === '') {
                    alert('数据错误');
                    return;
                }
                location.href = "/baike/cateremove?id=" + id;
            }
        });
        $('.set-dist').click(function () {
            if (confirm("您确定要推荐/取消推荐这个分类吗？")) {
                var id = $(this).attr('data-id');
                if (id === '') {
                    alert('数据错误');
                    return;
                }
                $.ajax({
                    url: '/baike/catetop?id=' + id,
                    type: 'get',
                    dataType: 'json',
                    data: {}
                })
                    .done(function (data) {
                        if (data.status == 1) {
                            window.location.reload();
                        } else {
                            alert(data.info);
                        }
                    })
                    .fail(function () {
                        alert('操作失败,请联系技术部门！');
                    });
            }
        });
        //点击弹窗
        $('.edit-category').click(function () {
            var id = $(this).attr("data-val");
            //查询对应分类的信息
            $.ajax({
                url: '/baike/getCategoryInfo',
                type: 'get',
                dataType: 'json',
                data: {id}
            })
                .done(function (data) {
                    if (data.status == 1) {
                        //初始化弹窗信息
                        changeHtmlData(data.info);
                    } else {
                        alert(data.info);
                    }
                })
                .fail(function () {
                    alert('操作失败,请联系技术部门！');
                });
            //显示弹窗
            $(this).attr("data-target", "#edit-category");
        });

        //新增弹窗
        $(".add-category").click(function () {
            changeHtmlData();
            $(this).attr("data-target", "#edit-category");
        });

        //保存
        $(".saveBtn").on('click', function () {
            if (checkData()) {
                var data = $("#edit_category_form").serializeArray();
                $.ajax({
                    url: '/baike/editCate',
                    type: 'post',
                    dataType: 'json',
                    data: data
                })
                    .done(function (data) {
                        if (data.status == 1) {
                            window.location.reload();
                        } else {
                            alert(data.info);
                        }
                    })
                    .fail(function () {
                        alert('操作失败,请联系技术部门！');
                    });
            }
        });

        function checkData() {
            var name = $('#edit_category_form input[name=name]').val();
            if (name === '') {
                $("input[name=name]").focus();
                $("input[name=name]").addClass('focus');
                alert("请填写分类名");
                return false;
            }
            var url = $("input[name=url]").val();
            if (url === '') {
                $("input[name=url]").focus();
                $("input[name=url]").addClass('focus');
                alert("请填写分类URL");
                return false;
            }
            return true;
        }

        function changeHtmlData(data) {
            //清楚数据
            $("#category_id").val(0);
            $("#category_id").attr('disabled', false);
            $("#edit_category_form input[name=name]").val('');
            $("#edit_category_form input[name=edit_id]").val('');
            $("#edit_category_form input[name=url]").val('');
            $("#edit_category_form input[name=order_id]").val('');
            $("#edit_category_form textarea[name=title]").val('');
            $("#edit_category_form textarea[name=keywords]").val('');
            $("#edit_category_form textarea[name=description]").val('');
            //存放数据
            if (data) {
                if (data.pid == 0) {
                    $("#category_id").val(0);
                    $("#category_id").attr('disabled', true);
                } else {
                    $("#category_id").attr('disabled', false);
                    $("#category_id").val(data.pid);
                }
                $("#edit_category_form input[name=name]").val(data.name);
                $("#edit_category_form input[name=edit_id]").val(data.cid);
                $("#edit_category_form input[name=url]").val(data.url);
                $("#edit_category_form input[name=order_id]").val(data.order_id);
                $("#edit_category_form textarea[name=title]").val(data.title);
                $("#edit_category_form textarea[name=keywords]").val(data.keywords);
                $("#edit_category_form textarea[name=description]").val(data.description);
            }
        }
    </script>
</block>