<extend name="Main:baseTemplate" />
<block name="title">
    <title>城市QQ群 - 控制台</title>
</block>
<block name="style">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" type="text/css" href="/assets/home/css/xs-gangwei.css?v={:C('STATIC_VERSION')}">
</block>
<block name="content">
    <div class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="overflow-x">
                        <div class="overflow-box" style="width: 1060px;">
                            <div class="box-header">
                                <h3><i class="xs-icon gangwei-icon"></i> 城市QQ群</h3>
                                <form class="form-horizontal">
                                    <div class="from-list">
                                        <style>
                                        .select2-container{width: 130px;vertical-align: middle;}
                                        .select2-choice{height: auto !important;line-height: 19px !important;padding-top: 0 !important;}
                                        .select2-container .select2-choice div b{background-position: 0 0 !important;}
                                        .width-800{width: 800px;}
                                        table#reset-table thead tr th{line-height: 45px;}
                                        </style>
                                        <div class="from-item">
                                            <span style="width: auto;float: left;line-height: 25px;">城市：</span>
                                            <select id="cityid" name="cityid" class="select2 select2-offscree pull-left">
                                                <option value="">所属城市</option>
                                                <volist name="citys" id="vo">
                                                    <option value="{$vo.id}">{$vo.city}</option>
                                                </volist>
                                            </select>
                                        </div>
                                        <div class="from-item">
                                            <span style="width: auto">录入时间：</span>
                                            <input id="time" class="datepicker" type="text" name="time" placeholder="选择日期" value="{$keyword.cnyf}">
                                        </div>
                                        <button class="search-btn xs-btn">查询</button>
                                    </div>
                                </form>
                            </div>
                            <div class="box-body">
                                <div class="todo-item">
                                    <a href="/salesetting/downloadmodule?type=6" style="color: #FFF;"><button class="xs-btn hideLoading">模板下载</button></a>
                                    <button class="xs-btn add-new" id="importAct">导入</button>
                                    <div class="pull-right position-relative">
                                        <a href="/salesetting/downloadmodule?type=6&data=1" style="color: #FFF;"><button class="xs-btn hideLoading">导出</button></a>
                                        <button class="xs-btn log-info">操作日志</button>
                                        <i class="xs-icon zhushi-icon"></i>
                                        <div class="zhushi-info">
                                            <p>本页数据以城市为唯一标识，其他数据均为城市附属信息</p>
                                            <p>此页系数的数值：整数</p>
                                            <p>每个月只保留导入的最近的1个月数据，</p>
                                            <p>以月份为单位，当月只保存当月最后1次记录保存。</p>
                                            <p>当月无导入，以上月数据为准</p>
                                            <p>5、操作日志：操作信息痕迹化，确保所有修改信息能够查询到记录。</p>
                                            <p>6、只有总裁、副总裁、司令、军长，助理可以访问。所有角色只能查看自己管辖的城市。</p>
                                            <p>7、总裁、副总裁：只有查看权限，无修改权限。司令最高权限，可设定军长，助理</p>
                                            <p>8、助理可设置师长及一下权限</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-item-count">
                                    <p><span class="count-list">共<i>{$totalnum}</i>条</span></p>
                                </div>
                                <table id="reset-table" class="table table-bordered table-hover dataTable no-footer" role="grid" >
                                    <thead class="thead1" style="width: 1060px;">
                                        <tr role="row">
                                            <th title="城市">城市</th>
                                            <th title="部门">部门</th>
                                            <th title="QQ群名称">QQ群名称</th>
                                            <th title="群成员数指标">群成员数指标</th>
                                            <th title="实际群成员数">实际群成员数</th>
                                            <th title="录入时间">录入时间</th>
                                            <th title="操作人">操作人</th>
                                            <th title="操作">操作</th>
                                        </tr>
                                    </thead>
                                    <thead class="thead2" style="width: 1060px;">
                                        <tr role="row">
                                            <th title="城市">城市</th>
                                            <th title="部门">部门</th>
                                            <th title="QQ群名称">QQ群名称</th>
                                            <th title="群成员数指标">群成员数指标</th>
                                            <th title="实际群成员数">实际群成员数</th>
                                            <th title="录入时间">录入时间</th>
                                            <th title="操作人">操作人</th>
                                            <th title="操作">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <volist name="list" id="v">
                                        <tr role="row" class="odd">
                                            <td><span>{$v.city}</span></td>
                                            <td><span>{$v.department}</span></td>
                                            <td><span>{$v.name}</span></td>
                                            <td><span>{$v.point|default='0'}</span></td>
                                            <td><span>{$v.num|default='0'}</span></td>
                                            <td class="revise-time">{$v.time}</td>
                                            <td><span class="pintuanzhang-text">{$v.manager}</span></td>
                                            <td class="revise"><i class="fa fa-pencil editnow" data-cid="{$v.mid}"></i></td>
                                        </tr>
                                        </volist>
                                    </tbody>
                                </table>
                                <div class="city-list-pop" style="top: 348px;">
                                    <volist name="list" id="v">
                                        <div>{$v.city}</div>
                                    </volist>
                                </div>
                            </div>
                            <div class="box-footer text-center">{$page}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade in" id="importExcel" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="" id="uploadForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">导入城市QQ群</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal .control-label">
                        <div style="overflow: hidden;">
                            <div class="col-xs-5 no-padding">
                                <h3>导入Excel表：</h3>
                                <input  type="file" name="excel" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="thisId" value="">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="upload">上传指标</button>
                </div>
                </form>
            </div>
        </div>
    </div>
    <!--公用记录模态框-->
    <div class="modal fade common-model" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog width-800">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                    </button>
                    <h4 class="modal-title">记录列表</h4>
                </div>
                <div class="modal-body common-model-content"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</block>
<block name="script">
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        $(function() {
            //上传
            $('#importAct').click(function(event){
                $('#importExcel').modal('show');
            });
            $("#upload").click(function () {
                //var formData = new FormData();
                //formData.append("excelFile", document.getElementById("file1").files[0]);
                var formData = new FormData($("#uploadForm")[0]);
                $.ajax({
                    url: "/salesetting/uploadqqgroupExcel",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.status == 1) {
                            alert("上传成功！"+data.data);
                            window.location.reload();
                        }
                        if (data.status == 0) {
                            alert(data.msg);
                        }
                    },
                    error: function () {
                        alert("上传失败！");
                    }
                });
            });

            $(".select2").select2();
            $("#cityid").select2("val","{$keyword.cityid}");
            $(".datepicker").datepicker({
                format:"yyyy-mm-dd",
                autoclose:true
            });
            // 修改 or 保存
            $('tbody').on('click', function(event){
                if(event.target.nodeName == 'I'){
                    var $a = $(event.target);
                    var val,arr=[];
                    if($a.hasClass('fa-floppy-o')){
                        
                        for(var i=0;i<$a.parent().parent().find('.info-item').length;i++){
                            val = $a.parent().parent().find('.info-item').eq(i).val();
                            arr.push(val);
                            if(val){
                                $a.parent().parent().find('td').eq(i+2).find('span').html(val);
                            }else{
                                $a.parent().parent().find('td').eq(i+2).find('select,input').focus();
                                return false;
                            }

                            if(arr.length < $a.parent().parent().find('.info-item').length){

                                for(var j=0;j<arr.length;j++){
                                    $a.parent().parent().find('td').eq(j+2).find('span').hide();
                                }
                            }else{
                                for(var j=0;j<arr.length;j++){

                                    $a.parent().parent().find('td').eq(j+2).find('span').show();

                                    $a.parent().parent().find('td').eq(j+2).find('div').hide();

                                    $a.parent().parent().removeClass('new-list');
                                }
                                for(var i=0;i<3;i++){
                                    $a.parent().parent().find('td').eq(i+2).find('div').remove()
                                }
                            }
                        }

                        var cid = $a.attr("data-cid");
                        //ajax写入数据
                        $.ajax({
                            url: '/salesetting/editQQGgroup/',
                            type: 'POST',
                            dataType: 'JSON',
                            data: {
                                cid:cid,
                                arr:arr
                            }
                        })
                        .done(function(data) {
                            if(data.status == '1'){
                                alert(data.info);
                                window.location.href = window.location.href;
                            }else{
                                alert(data.info);
                            }
                        })
                        .fail(function(xhr) {
                            alert('操作失败');
                        })

                        $a.removeClass('fa-floppy-o').addClass('fa-pencil');
                        $('.add-new').attr('disabled',false).css('background','#359bed');
                        // 都修改
                        $('.table tbody tr').each(function(index, el) {
                            $(this).find('.fa').each(function(index, el) {
                                $(el).show();
                            })
                        });
                    }else{

                        for(var i=0;i<3;i++){
                            var spanVal = $a.parent().parent().find('td').eq(i+2).find('span').html();
                            $a.parent().parent().find('td').eq(i+2).append('<div><input type="text" value="'+spanVal+'" name="" class="info-item"></div>');
                        }
                        for(var i=0;i<$a.parent().parent().find('.info-item').length;i++){

                            $a.parent().parent().find('div').eq(i).show();

                            $a.parent().parent().find('div').eq(i).siblings('span').hide();
                        }

                        $a.removeClass('fa-pencil').addClass('fa-floppy-o');

                        $('.add-new').attr('disabled',true).css('background','#ccc');
                        

                        // 只能编辑当前操作一条
                        $('.table tbody tr').each(function(index, el) {
                            if($(this).find('td:last').find('i').hasClass('fa-pencil')){
                                $(this).find('td:last').find('i').hide();
                            }
                        });
                    }
                }
            });
            // 注释信息
            $('.zhushi-icon').click(function() {
                if($(this).attr('show') == 'show'){
                    $('.zhushi-info').hide();
                    $(this).removeAttr('show')
                }else{
                    $('.zhushi-info').show();
                    $(this).attr('show','show');
                }
            });
            // 竖向滚动时，表格头部悬浮
            var x = 0;
            $(document).on('scroll',function(){
                $('.city-list-pop').css({'top':348-$(this).scrollTop()});
                if($(document).scrollTop() >= 340){
                    $('.thead1').show();
                    $('.thead2').css({'position':'fixed','top':0,'left':$('.sidebar').width()+26-x,'z-index':10});
                }else{
                    $('.thead1').hide();
                    $('.thead2').css({'position':'relative',left:0});
                }
            });
            // 横向滚动时，表格头部悬浮
            $('.overflow-x').on('scroll',function(){
                if($(this).scrollLeft()>130){
                    $('.city-list-pop').show();
                }else{
                    $('.city-list-pop').hide();
                }
                x = $(this).scrollLeft();
                $('.thead2').css({'left':$('.sidebar').width()+26-$(this).scrollLeft()});
                $('.city-list-pop').css({'left':$('.sidebar').width()});
            });

            //历史记录
            /*S-最近操作记录*/
            $('.log-info').click(function(event) {
                $.ajax({
                    url: '/salesetting/gethistorylog/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        type:9
                    }
                })
                .done(function(data) {
                    if (data.status == '1') {
                        $('.common-model-content').empty();
                        $('.common-model-content').html(data.data);
                        $('.common-model').modal('show');
                        $(".mask-self").remove();
                    } else {
                        $('.common-model-content').empty();
                        $('.common-model-content').html(data.info);
                        $('.common-model').modal('show');
                        $(".mask-self").remove();
                    }    
                })
                .fail(function(xhr) {
                    var e = dialog({
                        title: '消息',
                        content: '发生未知错误，请联系技术部门~',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function() {}
                    });
                    e.show();
                    return false;
                })
            });
        })
    </script>
</block>