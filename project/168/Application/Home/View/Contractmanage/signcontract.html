<link rel="stylesheet" type="text/css" href="/assets/home/contractmanage/css/uploaddocument.css?v={:C('STATIC_VERSION')}">
<div class="step_item_box">
    <div class="step_item_name">
        <span class="pull-left">合同/票据状态</span>
    </div>
    <div class="drag_handle">
        <span class="center_line"></span>
    </div>
    <div class="step2 step-container">
        <div class="input_box_line to_center" style="width:800px;">
            <span class="pull-left label_name">导入合同编号：</span>
            <span class="pull-left"><input type="text"  name="step1_hetong_inCode1" placeholder="请输入正确的合同编号！" value="" data-from="{$from}"></span>
            <button class="button hasBg" id="htTong_rightNow" data-type="1" data-special='4'>签约</button>
            <button class="button" id="zf_ht_btn" data-type="1" data-special='5'>作废</button>
            <button class="button" id="ys_ht_btn" data-type="1" data-special='3'>遗失</button>
        </div>
        <div class="input_box_line to_center" style="width:800px;">
            <span class="pull-left label_name">导入票据编号：</span>
            <span class="pull-left"><input type="text"  name="step1_piaoju_inCode1" placeholder="请输入正确的票据编号！" value="" data-from="{$from}"></span>
            <button class="button hasBg"  id="piaoJu_rightNow" data-type="2" data-special='4'>签约</button>
            <button class="button" id="zf_pj_btn" data-type="2" data-special='5'>作废</button>
            <button class="button" id="ys_pj_btn" data-type="2" data-special='3'>遗失</button>
        </div>
    </div>
</div>
<!--作废合同-->
<div class="center_content zuofei_hetong zuofei_imgs_up">
    <div class="center_head">请上传作废合同/票据照片</div>
    <div class="input_box_line no_height upload-document-contract">
        <div class="upload-document-preview-wrap" data-id="0">
            <div class="upload_img_list pull-left">
            </div>
        </div>
        <div class="upload_img_list pull-left owf" id="hetong_img_list"></div>
        <div class="upload_input_box pull-left">
            <input data-type="contract"  type="file" id="upload_hetong">
        </div>
        <span class="pull-left jingao">
            上传图片务必要清晰
        </span>
    </div>
    <div class="button_box">
        <button class="button" id="btn_zf_ht" data-status='0'>确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>
<!--遗失合同-->
<div class="center_content yishi_hetong">
    <div class="center_head">遗失原因:</div>
    <div class="upload_contianer">
        <textarea id="ys_ht_area" name="ys_ht_area" placeholder="请写明遗失时间,地点"></textarea>
    </div>
    <div class="button_box">
        <button class="button" id="btn_ys_ht">确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>

<!--作废票据-->
<div class="center_content zuofei_piaoju zuofei_imgs_up">
    <div class="center_head">请上传作废合同/票据照片</div>
    <div class="input_box_line no_height upload-document-piaoju">
        <div class="upload-document-preview-wrap" data-id="0">
            <div class="upload_img_list pull-left">
            </div>
        </div>
        <div class="upload_img_list pull-left owf" id="hetong_img_list"></div>
        <div class="upload_input_box pull-left">
            <input data-type="piaoju" type="file" id="upload_hetong">
        </div>
        <span class="pull-left jingao">
            上传图片务必要清晰
        </span>
    </div>
    <div class="button_box">
        <button class="button" id="btn_zf_pj" data-status='0'>确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>

<!--遗失票据-->
<div class="center_content yishi_piaoju">
    <div class="center_head">遗失原因:</div>
    <div class="upload_contianer">
        <textarea id="ys_pj_area" name="ys_pj_area" placeholder="请写明遗失时间,地点"></textarea>
    </div>
    <div class="button_box">
        <button class="button" id="btn_ys_pj">确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>
<script type="text/javascript" src="/assets/common/js/plugins/jquery-attach/js/jquery.attach.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
    /*上传作废合同*/
    $("#zf_ht_btn").click(function(){
        $("#bg_mask").fadeIn();
        $(".zuofei_hetong").fadeIn();
        $("#btn_zf_ht").attr('data-type',$(this).attr('data-type'));
        $("#btn_zf_ht").attr('data-special',$(this).attr('data-special'));
    });
    /*遗失合同*/
    $("#ys_ht_btn").click(function(){
        $("#bg_mask").fadeIn();
        $(".yishi_hetong").fadeIn();
        $("#btn_ys_ht").attr('data-type',$(this).attr('data-type'));
        $("#btn_ys_ht").attr('data-special',$(this).attr('data-special'));
    });
    /*遗失票据*/
    $("#ys_pj_btn").click(function(){
        $("#bg_mask").fadeIn();
        $(".yishi_piaoju").fadeIn();
        $("#btn_ys_pj").attr('data-type',$(this).attr('data-type'));
        $("#btn_ys_pj").attr('data-special',$(this).attr('data-special'));
    });
    /*作废票据*/
    $("#zf_pj_btn").click(function(){
        $("#bg_mask").fadeIn();
        $(".zuofei_piaoju").fadeIn();
        $("#btn_zf_pj").attr('data-type',$(this).attr('data-type'));
        $("#btn_zf_pj").attr('data-special',$(this).attr('data-special'));
    });
    
    $(".quxiao").click(function(){
         $(".zuofei_hetong,.yishi_hetong,.zuofei_piaoju,.yishi_piaoju").fadeOut();
         $("#bg_mask").fadeOut();
    });
        
    //合同/票据签约
    $("body").on('click','#htTong_rightNow,#piaoJu_rightNow',function(){
        //合同编号
        var contractStart = $('input[name=step1_hetong_inCode1]').val();
        //票据编号
        var ticketStart = $('input[name=step1_piaoju_inCode1]').val();
        var type = $(this).attr('data-type');
        var special = $(this).attr('data-special');
        var from = $('input[name=step1_hetong_inCode1]').attr('data-from');
        if(type == '1'){
            if(contractStart == ''){
                alert('请输入正确的合同编号！~');
                return false;
            }
            
        }else if(type == '2'){
            if(ticketStart == ''){
                alert('请输入正确的票据编号！~');
                return false;
            } 
        }
        
        $.ajax({
            url: '/contractmanage/salerchangestatus/',
            type: 'POST',
            dataType: 'JSON',
            data: {
                contractStart:contractStart,
                ticketStart:ticketStart,
                special:special,
                type:type,
                from:from
            }
        })
        .done(function(data) {
            if (data.status == '1') {
                alert(data.info);
            } else {
                alert(data.info);
            }    
        })
        .fail(function(xhr) {
            alert('发生未知错误，请联系技术部门~');
            return false;
        })
    });
    //合同/票据遗失
    $("body").on('click','#btn_ys_ht,#btn_ys_pj',function(){
        if(confirm("确认修改合同/票据状态为遗失吗？")){
            //合同编号
            var contractStart = $('input[name=step1_hetong_inCode1]').val();
            //票据编号
            var ticketStart = $('input[name=step1_piaoju_inCode1]').val();
            var type = $(this).attr('data-type');
            var special = $(this).attr('data-special');
            var from = $('input[name=step1_hetong_inCode1]').attr('data-from');
            if(type == '1'){
                //合同
                var reason = $('#ys_ht_area').val();
                if(contractStart == ''){
                    alert('请输入正确的合同编号！~');
                    return false;
                }
                $(".yishi_piaoju").fadeOut();
                $("#bg_mask").fadeOut();
            }else if(type == '2'){
                //票据
                var reason = $('#ys_pj_area').val();
                if(ticketStart == ''){
                    alert('请输入正确的票据编号！~');
                    return false;
                }
                $(".yishi_piaoju").fadeOut();
                $("#bg_mask").fadeOut();
            }
            if(reason == ''){
                alert('请写明遗失时间,地点！');
                return false;
            }
            $.ajax({
                url: '/contractmanage/salerchangestatus/',
                type: 'POST',
                dataType: 'JSON',
                data: {
                    contractStart:contractStart,
                    ticketStart:ticketStart,
                    special:special,
                    type:type,
                    reason:reason,
                    from:from
                }
            })
            .done(function(data) {
                if (data.status == '1') {
                    alert(data.info);
                    window.location.href = window.location.href;
                } else {
                    alert(data.info);
                }    
            })
            .fail(function(xhr) {
                alert('发生未知错误，请联系技术部门~');
                return false;
            })
        } 
    });
   
    //图片上传功能
    $(".zuofei_imgs_up :input[type='file']").attachsvr({
        onComplete:function(json,wrap){
            $(wrap).parent().parent().find('.upload-document-preview-wrap .upload_img_list').find('.img_box_container:last').find('img').attr('data-key', json.data.name);
        },
        onProgress:function(xhr){
            console.log("progress,在这里可以添加loading 效果",parseInt(xhr.loaded/xhr.totalSize*100)+"%")
        },
        onCheck:function(file, wrap){
            //判断是否点击了查询按钮，成功获取了将要修改的编号

            //文件预览
            var reader = new FileReader();
            reader.onload = function ( event ) {
                //预览样式
                var str =  '<div class="img_box_container pull-left">' +
                                '<div class="remove_img">' +
                                    '<i class="fa fa-close"></i>' +
                                '</div>' +
                                '<div>' +
                                    '<img class="document-file" src="'+event.target.result+'">' +
                                '</div>' +
                            '</div>';
                var previewListObject = $(str);
                previewListObject.find('.remove_img').click(function(event) {
                    $(this).parent().remove();
                });
                $(wrap).parent().parent().find('.upload-document-preview-wrap .upload_img_list').append(previewListObject);
            };
            reader.readAsDataURL(file[0].files[0]);
            return true;
        },
        onError:function(e){console.log("error",e)},
        ctxdata:{
            "token":"{$vars.token}"
        },
        script:"http://upload.qiniu.com/",
        uploadkey:"file",
        filetype:[".jpg",".png",".jpeg"]
    });
    //合同/票据作废
    //上传票据保存
    $('#btn_zf_pj,#btn_zf_ht').click(function(event) {
        if(confirm("确认修改合同/票据状态为作废吗？")){
            //合同编号
            var contractStart = $('input[name=step1_hetong_inCode1]').val();
            //票据编号
            var ticketStart = $('input[name=step1_piaoju_inCode1]').val();
            var type = $(this).attr('data-type');
            var special = $(this).attr('data-special');
            var from = $('input[name=step1_hetong_inCode1]').attr('data-from');
            if(type == '1'){
                //合同
                var contractImage = [];
                $('.upload-document-contract').find('.img_box_container').each(function(index, el) {
                    contractImage.push($(this).find('img').attr('data-key'));
                });
            }else if(type == '2'){
                //票据
                var piaojuImage = [];
                $('.upload-document-piaoju').find('.img_box_container').each(function(index, el) {
                    piaojuImage.push($(this).find('img').attr('data-key'));
                });
            }
            if(type == '1'){
                //合同
                var reason = $('#ys_ht_area').val();
                if(contractStart == ''){
                    alert('请输入正确的合同编号！~');
                    return false;
                }
                $(".yishi_piaoju").fadeOut();
                $("#bg_mask").fadeOut();
            }else if(type == '2'){
                //票据
                var reason = $('#ys_pj_area').val();
                if(ticketStart == ''){
                    alert('请输入正确的票据编号！~');
                    return false;
                }
                $(".yishi_piaoju").fadeOut();
                $("#bg_mask").fadeOut();
            }

            $.ajax({
                url: '/contractmanage/salerchangestatus/',
                type: 'POST',
                dataType: 'JSON',
                async: false,
                data: {
                    contractStart:contractStart,
                    ticketStart:ticketStart,
                    type:type,
                    special:special,
                    contractImage:contractImage,
                    piaojuImage:piaojuImage,
                    from:from
                }
            })
            .done(function(data) {
                alert(data.info);
                //window.location.href = window.location.href;
            })
            .fail(function(xhr) {
                alert('网络错误，请稍后重试')
            });
        }
    });

</script>