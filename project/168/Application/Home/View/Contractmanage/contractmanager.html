<!--审核-->
<link href="/assets/home/hetong/css/alert_info.css?v={:C('STATIC_VERSION')}" rel="stylesheet" type="text/css" />
<link href="/assets/home/hetong/css/contractmanager.css?v={:C('STATIC_VERSION')}" rel="stylesheet" type="text/css" />
<script  type="text/javascript" src="/assets/home/hetong/js/alert_info.js?v={:C('STATIC_VERSION')}"></script>
<div class="step_item_box">
    <div class="step_item_name">
        <span class="pull-left">
            合同管理
        </span>
    </div>
    <div class="drag_handle">
        <span class="center_line">
        </span>
    </div>
    <div class="step1 step-container kucunshenqwk">
        <div class="search_box_x150">
            <span class="serach_title_x150">条件查询：</span>
            <input type="text" name="contarct_search" placeholder="请输入正确的编号" id="searchForPlay">
            <button class="button searchForPlay">查询</button>
            <br>
            <span style="color: red;margin-left: 20px; margin-top: 5px;">重要提示：输入格式为7位有效数字</span>
        </div>
        <div class="contract_manager_x150">
            <span class="search_active_x150">待签约</span>
            <span>签约</span>
            <span>作废</span>
            <span>遗失</span>
            <span>审核结果</span>
        </div>
        <div class="manage_tab_x150 manager_table">
            <!--待签约-->
            <table class="table_active_x150 scroll_table" data-part="1">
                <thead>
                    <tr class="tab_head_x150">
                        <td>合同编号</td><td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <volist name="besignedup" id="v">
                        <tr>
                            <td>{$v.contractid}</td>
                            <td>
                                <button class="button small_button besignedup_qianyue" data-id="{$v.id}" data-special='4' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>签约</button>
                                &nbsp;&nbsp;
                                <button class="button  small_button besignedup_zuofei" data-id="{$v.id}" data-special='5' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>作废</button>
                                &nbsp;&nbsp;
                                <button class="button  small_button besignedup_yishi" data-id="{$v.id}" data-special='7' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>遗失</button>
                            </td>
                        </tr>
                    </volist>
                </tbody>
            </table>
            <!--签约-->
            <table class="scroll_table"  data-part="2">
                <thead>
                    <tr class="tab_head_x150">
                        <td>合同编号</td><td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <volist name="signedforverify" id="v">
                        <tr>
                            <td>{$v.contractid}</td>
                            <td>

                                <button class="button  small_button besignedup_zuofei" data-id="{$v.id}" data-special='5' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>作废</button>
                                &nbsp;&nbsp;
                                <button class="button  small_button besignedup_yishi" data-id="{$v.id}" data-special='3' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>遗失</button>
                            </td>
                        </tr>
                    </volist>

                </tbody>
            </table>
            <!--作废-->
            <table class="scroll_table"  data-part="3">
                <thead>
                    <tr class="tab_head_x150">
                        <td>合同编号</td><td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <volist name="becancellation" id="v">
                        <tr>
                            <td>{$v.contractid}</td>
                            <td>
                                <button class="button small_button besignedup_qianyue" data-id="{$v.id}" data-special='4' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>签约</button>
                                &nbsp;&nbsp;
                                <button class="button  small_button besignedup_yishi" data-id="{$v.id}" data-special='3' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>遗失</button>
                            </td>
                        </tr>
                    </volist>
                </tbody>
            </table>
            <!--遗失-->
            <table class="scroll_table"  data-part="4">
                <thead>
                    <tr class="tab_head_x150">
                        <td>合同编号</td><td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <volist name="belost" id="v">
                        <tr>
                            <td>{$v.contractid}</td>
                            <td>
                                <button class="button small_button findBack" data-id="{$v.id}" data-special='6' data-contractid="{$v.contractid}" <if condition="$v.type LT 6">data-type="1"<else />data-type="2"</if>>找回</button>
                            </td>
                        </tr>
                    </volist>
                </tbody>
            </table>
            <!--审核通过-->
            <table class="scroll_table"  data-part="5">
                <thead>
                    <tr class="tab_head_x150">
                        <td>合同编号</td><td>状态</td>
                    </tr>
                </thead>
                <tbody>
                    <volist name="haschecked" id="v">
                        <tr>
                            <td>{$v.contractid}</td>
                            <td>
                                <if condition="$v.beaccept eq 3"><span class="has_end">签约</span><elseif  condition="$v.beaccept eq 4"/><span class="no_start">作废</span><elseif  condition="$v.beaccept eq 5"/><span class="re_write">遗失</span></if>
                            </td>
                        </tr>
                    </volist>
                </tbody>
            </table>
        </div>
    </div>
</div>
<!--作废合同-->
<div class="center_content zuofei_hetong zuofei_imgs_up" id="zuofei_now">
    <div class="center_head">请上传作废合同/票据照片</div>
    <div class="input_box_line no_height upload-document-contract">
        <div class="upload-document-preview-wrap" data-id="0">
            <div class="upload_img_list pull-left">
            </div>
        </div>
        <div class="upload_img_list pull-left owf" id="hetong_img_list"></div>
        <div class="upload_input_box pull-left">
            <input data-type="contract"  type="file" id="upload_hetong">
        </div>
        <span class="pull-left jingao">
            上传图片务必要清晰
        </span>
    </div>
    <div class="button_box">
        <button class="button" id="besignedup_zuofei" data-status='0'>确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>
<!--遗失合同-->
<div class="center_content yishi_hetong"  id="yishi_now">
    <div class="center_head">遗失原因:</div>
    <div class="upload_contianer">
        <textarea id="ys_ht_area" name="ys_ht_area" placeholder="请写明遗失时间,地点"></textarea>
    </div>
    <div class="button_box">
        <button class="button" id="besignedup_yishi">确认</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="button quxiao" >取消</button>
    </div>
</div>
<script>
    $(function(){
        //审核界面
        $(".contract_manager_x150 span").click(function(event) {
            var index=$(this).index();
            var table_tab=$(".manager_table table");
            $(this).addClass('search_active_x150');
            $(this).siblings('span').removeClass('search_active_x150');
            $(table_tab[index]).addClass('table_active_x150');
            $(table_tab[index]).siblings("table").removeClass('table_active_x150');
        });

        /*上传作废合同*/
        $(document).on('click','.besignedup_zuofei',function(){
            $("#besignedup_zuofei").attr('data-type',$(this).attr('data-type'));
            $("#besignedup_zuofei").attr('data-special',$(this).attr('data-special'));
            $("#besignedup_zuofei").attr('data-contractid',$(this).attr('data-contractid'));
            $("#bg_mask").fadeIn();
            $("#zuofei_now").fadeIn();
        });
        /*遗失合同*/
        $(document).on('click','.besignedup_yishi',function(){
            $("#bg_mask").fadeIn();
            $("#yishi_now").fadeIn();
            $("#besignedup_yishi").attr('data-type',$(this).attr('data-type'));
            $("#besignedup_yishi").attr('data-special',$(this).attr('data-special'));
            $("#besignedup_yishi").attr('data-contractid',$(this).attr('data-contractid'));
        });


        $(".quxiao").click(function(){
             $(".zuofei_hetong,.yishi_hetong,.zuofei_piaoju,.yishi_piaoju").fadeOut();
             $("#bg_mask").fadeOut();
        });

        //图片上传功能
        $(".zuofei_imgs_up :input[type='file']").attachsvr({
            onComplete:function(json,wrap){
                $(wrap).parent().parent().find('.upload-document-preview-wrap .upload_img_list').find('.img_box_container:last').find('img').attr('data-key', json.data.name);
            },
            onProgress:function(xhr){
                console.log("progress,在这里可以添加loading 效果",parseInt(xhr.loaded/xhr.totalSize*100)+"%")
            },
            onCheck:function(file, wrap){
                //判断是否点击了查询按钮，成功获取了将要修改的编号

                //文件预览
                var reader = new FileReader();
                reader.onload = function ( event ) {
                    //预览样式
                    var str =  '<div class="img_box_container pull-left">' +
                                    '<div class="remove_img">' +
                                        '<i class="fa fa-close"></i>' +
                                    '</div>' +
                                    '<div>' +
                                        '<img class="document-file" src="'+event.target.result+'">' +
                                    '</div>' +
                                '</div>';
                    var previewListObject = $(str);
                    previewListObject.find('.remove_img').click(function(event) {
                        $(this).parent().remove();
                    });
                    $(wrap).parent().parent().find('.upload-document-preview-wrap .upload_img_list').append(previewListObject);
                };
                reader.readAsDataURL(file[0].files[0]);
                return true;
            },
            onError:function(e){console.log("error",e)},
            ctxdata:{
                "token":"{$vars.token}"
            },
            script:"http://upload.qiniu.com/",
            uploadkey:"file",
            filetype:[".jpg",".png",".jpeg"]
        });

        //合同/票据找回
        $(document).on('click','.findBack',function(){
            if(confirm("确认修改合同/票据状态为已找回吗？")){
                var type = $(this).attr('data-type');
                var special = $(this).attr('data-special');
                if(type == '1'){
                    //合同编号
                    var contractStart = $(this).attr('data-contractid');
                }else if(type == '2'){
                    //票据编号
                    var ticketStart = $(this).attr('data-contractid');
                }
                $.ajax({
                    url: '/contractmanage/salerchangestatus/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        contractStart:contractStart,
                        ticketStart:ticketStart,
                        special:special,
                        type:type,
                        from:{$from}
                    }
                })
                .done(function(data) {
                    if (data.status == '1') {
                        alert(data.info);
                        window.location.href = window.location.href;
                    } else {
                        alert(data.info);
                    }
                })
                .fail(function(xhr) {
                    alert('发生未知错误，请联系技术部门~');
                    return false;
                })
            }
        });
        //合同/票据签约
        $(document).on('click','.besignedup_qianyue',function(){
            if(confirm("确认修改合同/票据状态为已签约吗？")){
                var type = $(this).attr('data-type');
                var special = $(this).attr('data-special');
                if(type == '1'){
                    //合同编号
                    var contractStart = $(this).attr('data-contractid');
                }else if(type == '2'){
                    //票据编号
                    var ticketStart = $(this).attr('data-contractid');
                }
                $.ajax({
                    url: '/contractmanage/salerchangestatus/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        contractStart:contractStart,
                        ticketStart:ticketStart,
                        special:special,
                        type:type,
                        from:{$from}
                    }
                })
                .done(function(data) {
                    if (data.status == '1') {
                        alert(data.info);
                        window.location.href = window.location.href;
                    } else {
                        alert(data.info);
                    }
                })
                .fail(function(xhr) {
                    alert('发生未知错误，请联系技术部门~');
                    return false;
                })
            }
        });
        // //合同/票据遗失
        $(document).on('click','#besignedup_yishi',function(){
            if(confirm("确认修改合同/票据状态为遗失吗？")){
                var type = $(this).attr('data-type');
                var special = $(this).attr('data-special');
                if(type == '1'){
                    //合同编号
                    var contractStart = $(this).attr('data-contractid');
                }else if(type == '2'){
                    //票据编号
                    var ticketStart = $(this).attr('data-contractid');
                }
                var reason = $('#ys_ht_area').val();
                if(reason == ''){
                    alert('请写明遗失时间,地点！');
                    return false;
                }
                $.ajax({
                    url: '/contractmanage/salerchangestatus/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        contractStart:contractStart,
                        ticketStart:ticketStart,
                        special:special,
                        type:type,
                        reason:reason,
                        from:{$from}
                    }
                })
                .done(function(data) {
                    if (data.status == '1') {
                        alert(data.info);
                        window.location.href = window.location.href;
                    } else {
                        alert(data.info);
                    }
                })
                .fail(function(xhr) {
                    alert('发生未知错误，请联系技术部门~');
                    return false;
                })
            }
        });
        // //合同/票据作废
        // //上传票据保存
        $(document).on('click','#besignedup_zuofei',function(){
            if(confirm("确认修改合同/票据状态为作废吗？")){
                var type = $(this).attr('data-type');
                var special = $(this).attr('data-special');
                if(type == '1'){
                    //合同编号
                    var contractStart = $(this).attr('data-contractid');
                    //合同
                    var contractImage = [];
                    $('.upload-document-contract').find('.img_box_container').each(function(index, el) {
                        contractImage.push($(this).find('img').attr('data-key'));
                    });
                }else if(type == '2'){
                    //票据编号
                    var ticketStart = $(this).attr('data-contractid');
                    //票据
                    var piaojuImage = [];
                    $('.upload-document-contract').find('.img_box_container').each(function(index, el) {
                        piaojuImage.push($(this).find('img').attr('data-key'));
                    });
                }
                $.ajax({
                    url: '/contractmanage/salerchangestatus/',
                    type: 'POST',
                    dataType: 'JSON',
                    async: false,
                    data: {
                        contractStart:contractStart,
                        ticketStart:ticketStart,
                        type:type,
                        special:special,
                        contractImage:contractImage,
                        piaojuImage:piaojuImage,
                        from:{$from}
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    window.location.href = window.location.href;
                })
                .fail(function(xhr) {
                    alert('网络错误，请稍后重试')
                });
            }
        });

        //按编号搜索合同
        $('.searchForPlay').click(function(){
            var keyword = $("#searchForPlay").val();
            var part = $(".table_active_x150").attr('data-part');
            $.ajax({
                url: '/contractmanage/searchforcontract/',
                type: 'POST',
                dataType: 'JSON',
                async: false,
                data: {
                    keyword:keyword,
                    part:part,
                    position:3
                }
            })
            .done(function(data) {
                if(data.status == 1){
                    //$("#qianyuepart").html(data.data.qianyue);
                    //$("#zuofeipart").html(data.data.zuofei);
                    $(".table_active_x150 tbody").html(data.data);
                }else{
                    alert(data.info);
                }
            })
            .fail(function(xhr) {
                alert('网络错误，请稍后重试')
            });
        });
    })
</script>