<extend name="Main:baseTemplate" />
<block name="title">
    <title>齐装网品牌榜专题添加后台 - 控制台</title>
</block>
<block name="style">
    <link href="{:C('168NEW_URL')}/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" rel="stylesheet" />
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/validation/css/validationEngine.jquery.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/ui-dialog.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/css/brandtopic.css?v={:C('STATIC_VERSION')}">
</block>

<block name="content">
    <section class="content-header">
        <h1>品牌榜专题添加</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="/brandtopic/">品牌榜专题管理</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="nav-tabs-custom">
            <div class="row">
                <div class="form-horizontal ">
                    <form id="brandtopic">
                        <div class="box-body">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    公司名字
                                </label>
                                <div class="col-sm-3">
                                    <input type="text" id="search">
                                </div>
                                <div class="col-sm-1">
                                    <input id="comid" type="text" disabled class="form-control" placeholder="公司ID">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    所在城市
                                </label>
                                <div class="col-sm-3">
                                    <span id="city" type="text" disabled class="form-control"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    公司口号
                                </label>
                                <div class="col-sm-4">
                                    <input type="text" id="kouhao" class="form-control" value="{$info.value}" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputId" class="col-sm-2 control-label">
                                    有效日期
                                </label>
                                <div class="col-sm-2">
                                    <input type="text" name="start_time" class="form-control form_datetime validate[required]" value="{$overtime.start|default=''|date='Y-m-d',###}" />
                                </div>
                                <div class="col-sm-2">
                                    <input type="text" name="end_time" class="form-control form_datetime validate[required]"  value="{$overtime.end|default=''|date='Y-m-d',###}"/>
                                </div>
                                <div class="col-sm-5 adv-error">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    广告位置
                                </label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control validate[required]" placeholder="广告位置" name="sort">
                                </div>
                                <div class="col-sm-6 adv-error">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    广告备注
                                </label>
                                <div class="col-sm-4">
                                    <textarea class="form-control" placeholder="广告备注" name="description"></textarea>
                                </div>
                                <div class="col-sm-6 adv-error">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">
                                    是否有效
                                </label>
                                <div class="col-sm-2">
                                    <select class="form-control" id="status">
                                        <option value="1" selected>有效</option>
                                        <option value="0">无效</option>
                                    </select>
                                </div>
                                <div class="col-sm-6 adv-error">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-5 col-sm-offset-3 adv-error img-error">
                                </div>
                                <input type="hidden" name="advimg" value="">
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">上传图片</label>
                                <div class="col-sm-4">
                                     <input id="file-Brand" type="file" multiple/>
                                     <input type="hidden" name="files"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-sm-2"></div>
                                    <div class="col-xs-4">
                                        <div class="alert alert-warning alert-dismissible fade in" role="alert">
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">    <span aria-hidden="true">×</span>
                                            </button>
                                            <strong>注意事项：</strong> 广告图片大小限制：请不要超出100K！尺寸：126*63
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box-footer">
                            <div class="col-sm-4"></div>
                            <div class="col-sm-2">
                                <button id="add" type="button" class="btn btn-success pull-right"><i class="fa fa-plus-circle"></i>增加
                                </button>
                                <a href="/brandtopic/">
                                    <button type="button" class="btn btn-default pull-right"><i class="fa fa-mail-reply"></i>返回</button>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
</block>
<block name="script">
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/jquery.validate.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/validation/js/jquery.validationEngine_zh_CN.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/validation/js/jquery.validationEngine.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/dialog.min.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            // 自定义参数调用
            $('#brandtopic').validationEngine('attach', {
              promptPosition: 'centerRight',
              autoHidePrompt: true,
              autoHideDelay: '1000',
              scroll: true
            });

            $(".form_datetime").datepicker({
                format:"yyyy-mm-dd",
                minViewMode:0
            });

            $("#file-Brand").fileinput({
                language: 'zh', //设置语言,
                uploadUrl:"/upload/uploadimg/",
                showCaption:false,
                browseClass:"btn btn-primary",
                allowedFileExtensions : ['jpg','png','gif'],
                maxFileCount:1,
                uploadClass:"btn btn-info",
                removeClass:"btn btn-danger",
                uploadAsync:true,
                dropZoneEnabled:false,
                previewSettings:{
                    image: {width: "auto", height: "100px"}
                },
                /*minImageWidth: 126,
                minImageHeight: 63,
                maxImageWidth: 126,
                maxImageHeight: 63,*/
                layoutTemplates:{
                    actionDelete:"",
                    actionUpload:""
                },
                uploadExtraData:{
                    prefix:'qzlogo'
                }
            }).on('fileuploaded', function(event, data) {
                if(1 == data.response.status){
                    $('input[name=files]').val(data.response.data.name);
                }else{
                    var d = dialog({
                        title: '消息',
                        content: data.response.info,
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {
                        }
                    });
                    d.show();
                    return false;
                }
            }).on("fileuploaderror",function(event, data){
                var e = dialog({
                    title: '消息',
                    content: '文件上传失败,请检查文件格式，规格是否符合要求，或联系技术部门！',
                    okValue: '确 定',
                    quickClose: true,
                    ok: function () {}
                });
                e.show();
                return false;
            }).on("fileclear",function(){
                $("input[name=files]").val("");
            });


            $('#add').click(function(){
                if(! $('#brandtopic').validationEngine('validate')){
                    return false;
                }
                var data = new Object();
                data.start_time = $('input[name=start_time]').val();
                data.end_time = $('input[name=end_time]').val();
                if(data.end_time < data.start_time){
                    var k = dialog({
                        title: '消息',
                        content: '开始时间不能大于结束时间！！',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {
                        }
                    });
                    k.show();
                    return false;
                }

                data.img_url = $('input[name=files]').val();
                data.description = $('textarea[name=description]').val();
                data.sort = $('input[name=sort]').val();
                if('' == $('#city').text()){
                    var g = dialog({
                        title: '消息',
                        content: '请选择装修公司名字！！',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {}
                    });
                    g.show();
                    return false;
                }
                if('' == data.img_url){
                    var k = dialog({
                        title: '消息',
                        content: '请上传装修公司LOGO！！',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {
                        }
                    });
                    k.show();
                    return false;
                }
                data.status = $("#status").val();
                data.city_id = $("#search").select2("data").cs;
                data.company_id = $("#search").select2("data").id;
                data.company_name = $("#search").select2("data").text;
                data.value = $('#kouhao').val();
                $.ajax({
                    url: '/brandtopic/add/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        data:data
                    }
                })
                .done(function(data) {
                    if(data.status == '1'){
                        window.location.href = window.location.href;
                    }else{
                        var e = dialog({
                            title: '消息',
                            content: data.info,
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {}
                        });
                        e.show();
                    }
                })
                .fail(function(xhr) {
                    var e = dialog({
                        title: '消息',
                        content: '操作失败,请联系技术部门！',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {}
                    });
                    e.show();
                })
            })

            $("#search").select2({
                allowClear: true,
                minimumInputLength: 1,
                maximumInputLength:10,
                query: function(query) {
                    var result = null;
                    $.ajax({
                        url: '/api/getcompanyinfo',
                        type: 'GET',
                        dataType: 'JSON',
                        data: {
                            query: query.term
                        }
                    })
                    .done(function(data) {
                        if(data.status == 1){
                            var result = {
                                results: []
                            };
                            var company = data.data;
                            for(var i in data.data){
                                result.results.push({
                                    id:data.data[i].id,
                                    text: data.data[i].jc,
                                    cs: data.data[i].cs,
                                    kouhao: data.data[i].kouhao,
                                    cname:data.data[i].cname
                                });
                            }
                            $('#search').change(function(){
                                var cname = $("#search").select2("data").cname;
                                var comid = $("#search").select2("data").id;
                                var kouhao = $("#search").select2("data").kouhao;
                                $('#city').text(cname);
                                $('#comid').val(comid);
                                $('#kouhao').val(kouhao);
                            })
                            query.callback(result);
                        }
                    });
                }
            });
        })
    </script>
</block>