<extend name="Main:baseTemplate" />
<block name="title">
    <title>齐装网品牌榜编辑后台 - 控制台</title>
</block>
<block name="style">
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/ui-dialog.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/validation/css/validationEngine.jquery.css?v={:C('STATIC_VERSION')}">
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/plugins/select2/css/select2.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/css/meitu.css?v={:C('STATIC_VERSION')}">




<link rel="stylesheet"  href="{:C('168NEW_URL')}/assets/common/plugins/webuploader/dist/webuploader.css?v={:C('STATIC_VERSION')}">
<link rel="stylesheet"  href="{:C('168NEW_URL')}/assets/common/plugins/webuploader/upload.css?v={:C('STATIC_VERSION')}" />








</block>
<block name="content">
    <section class="content-header">
        <h1>美图操作</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="/article/">美图管理</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="box box-default color-palette-box">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="fa fa-tag"></i> 美图操作</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    <div id="categorydetails" class="col-md-12">
                        <div class="nav-tabs-custom">
                            <form id="form" action="javascript:void(0)" method="POST">
                                <div class="tab-content">
                                    <!-- 常规 -->
                                    <div class="tab-pane active" id="tab_1">
                                        <div class="box-body">
                                            <div class="form-group">
                                                <label>标题</label>
                                                <div class="row">
                                                    <div class="col-xs-8">
                                                        <input type="input" class="form-control validate[required]" name="title" placeholder="标题" value="{$info.info.title}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group attribute-wrap">
                                                <label>位置</label>
                                                <div class="row">
                                                    <div class="col-xs-12 location-wrap">
                                                        <volist name="info.attribute.location" id="vo">
                                                            <in name="vo.id" value="$info.info.location">
                                                                <button class="btn btn-info btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            <else />
                                                                <button class="btn btn-default btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            </in>
                                                        </volist>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group attribute-wrap">
                                                <label>风格</label>
                                                <div class="row">
                                                    <div class="col-xs-12 fengge-wrap">
                                                        <volist name="info.attribute.fengge" id="vo">
                                                            <in name="vo.id" value="$info.info.fengge">
                                                                <button class="btn btn-info btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            <else />
                                                                <button class="btn btn-default btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            </in>
                                                        </volist>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group attribute-wrap">
                                                <label>户型</label>
                                                <div class="row">
                                                    <div class="col-xs-12 huxing-wrap">
                                                        <volist name="info.attribute.huxing" id="vo">
                                                            <in name="vo.id" value="$info.info.huxing">
                                                                <button class="btn btn-info btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            <else />
                                                                <button class="btn btn-default btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            </in>
                                                        </volist>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group attribute-wrap">
                                                <label>色彩</label>
                                                <div class="row">
                                                    <div class="col-xs-12 color-wrap">
                                                        <volist name="info.attribute.color" id="vo">
                                                            <in name="vo.id" value="$info.info.color">
                                                                <button class="btn btn-info btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            <else />
                                                                <button class="btn btn-default btn-sm" type="button" data-id="{$vo.id}">{$vo.name}</button>
                                                            </in>
                                                        </volist>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>标签</label>
                                                <div class="row">
                                                    <div class="col-sm-9">
                                                        <select name="tags" class="tags form-control" id="tags" multiple="">
                                                        <notempty name="info.info.tagname">
                                                            <volist name="info.info.tagname" id="vo">
                                                                <option value="{$vo}" selected>{$vo}</option>
                                                            </volist>
                                                        </notempty>
                                                        </select>
                                                        <input name="tagnames" id="tagnames" type="hidden">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>关键字</label>
                                                <div class="row">
                                                    <div class="col-xs-6">
                                                    <input type="input" class="form-control validate[required]" name="keyword" placeholder="关键字" value="{$info.info.keyword}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>描述</label>
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <textarea class="form-control validate[required]" name="description">{$info.info.description}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>是否推荐</label>
                                                <select name="istop" class="form-control" id="istop" >
                                                    <option  value="0" selected>否</option>
                                                    <option  value="1">是</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>美图列表</label>
                                                <div class="row">
                                                    <div class="col-xs-12  img-iframe">
                                                        <div id="uploader" class="uploader" data-data='{$meitu.images}'>
                                                        </div>
                                                        <input id="images" type="hidden" name="imgs"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-success btn-save">
                                                <i class="fa fa-save"></i>&nbsp;保存
                                            </button>
                                            <button type="button" class="btn btn-default" onclick="history.back(-1)">
                                                <i class="fa fa-mail-reply"></i>&nbsp;返回
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</block>
<block name="script">
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/validation/js/jquery.validationEngine_zh_CN.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/validation/js/jquery.validationEngine.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/artdialog/dialog.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/plugins/select2/js/select2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/plugins/select2/js/zh-CN.js?v={:C('STATIC_VERSION')}"></script>


    <script src="{:C('168NEW_URL')}/assets/common/plugins/webuploader/dist/webuploader.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/plugins/webuploader/upload.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/plugins/webuploader/jquery.dragsort.min.js?v={:C('STATIC_VERSION')}"></script>


    <script type="text/javascript">
        $(document).ready(function(){
            $('.form-group button').click(function(event) {
                if($(this).hasClass('btn-info')){
                    $(this).removeClass('btn-info').addClass('btn-default');
                }else{
                    $(this).removeClass('btn-default').addClass('btn-info');
                }
            });

            $(".tags").select2({
                language: "zh-CN",
                tags: false,
                multiple: true, //是否使用多个标签
                ajax: {
                    url: "/tags/gettagsapi/",
                    dataType: 'json',
                    type: 'GET',
                    delay: 1000,
                    data: function (params) {
                      return {
                        key: params.term, //查询参数
                      };
                    },
                    processResults: function (data, page) {
                        var parsed = data.data;
                        var arr = [];
                        for(var x in parsed){
                            arr.push(parsed[x]); //这个应该是个json对象
                        }
                        return {
                            results: arr
                        };
                    },
                    cache: true
                  },
                escapeMarkup: function (markup) { return markup; },
                /*最小需要输入多少个字符才进行查询，与之相关的小需要输入多少个字符才进行查询，与之相关的maximumSelectionLength表示最大输入限制*/
                minimumInputLength: 1
            });

            $(".img-iframe").uploader({
                host:"{:C('QINIU_DOMAIN')}",
                old_host:"{:C('STATIC_HOST1')}",
                server:"/upload/uploadimg/",
                drag:true,
                formData:{
                    prefix:"meitu"
                },
                extend:true,
                removePath:"/meitu/deletemeituimgbyid/",
                callback:function(res){
                    var data =  $("input[name=imgs]").data("data");
                    if(typeof data == "undefined"){
                        data = [];
                    }
                    img = {
                        id:res["id"],
                        path:res["data"],
                        tabIndex:res.tabIndex
                    }
                    data.push(img);
                    $("input[name=imgs]").data("data",data);
                }
            });

            $('.btn-save').click(function(){
                if(! $('#form').validationEngine('validate')){
                    return false;
                }
                var tags = $("#tags").select2("data");
                var tagnames = '';
                $.each(tags,function(n,value) {
                    tagnames = tagnames + value.text + ',';
                });
                $('#tagnames').val(tagnames);
                var data = $('#form').serializeArray();

                var imgData = $("#images").data("data");
                if(typeof imgData  != "undefined"){
                    for(var i = 0; i< imgData.length;i++ ){
                        var index = $("#"+imgData[i].id).attr("tabIndex");
                        imgData[i].tabIndex = index;
                        imgData[i].on = typeof $("#"+imgData[i].id).attr("data-on") == "undefined"?0:2;
                        imgData[i].title = $("#tit_"+imgData[i].id).val();
                        imgData[i].description = $("#alt_"+imgData[i].id).val();
                    }
                    data["newImgs"] = JSON.stringify(imgData);
                }
                var imgs = [];
                $(".img-iframe li").each(function(){
                    var li = $(this);
                    if(typeof li.attr("data-id") != "undefined"){
                        var id = li.attr("data-id");
                        imgs.push({
                            id:id,
                            index:li.attr("tabIndex"),
                            on:li.hasClass("img_on")?2:0,
                            title:li.find("#tit_"+id).val(),
                            description:li.find("#alt_"+id).val()
                        });
                    }
                });
                data["imgs"] = JSON.stringify(imgs);

                console.log(imgages);
                return false;

                $.ajax({
                    url: '/meitu/operate/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: data
                })
                .done(function(data) {
                    if(data.status == '1'){
                        window.location.href = '/meitu/';
                    }else{
                        var e = dialog({
                            title: '消息',
                            content: data.info,
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {}
                        });
                        e.show();
                    }
                })
                .fail(function(xhr) {
                    var e = dialog({
                        title: '消息',
                        content: '操作失败,请联系技术部门！',
                        okValue: '确 定',
                        quickClose: true,
                        ok: function () {}
                    });
                    e.show();
                })
            })
        })
    </script>
</block>