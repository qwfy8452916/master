<extend name="Main:baseTemplate" />
<block name="title">
    <title>运营系统-业绩分析 - 部门管理</title>
</block>
<block name="style">
    <link rel="stylesheet" type="text/css" href="/assets/home/yy/css/pagecategory.css?v={:C('STATIC_VERSION')}">
</block>
<block name="content">
	<section class="content-header">
        <h4>部门管理</h4>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-body">
                        <div class="row">
                            <div class="col-xs-12" data-id="0" data-name="无">
                            	<div class="btn btn-success add-top-button"><i class="fa fa-plus-circle"></i> 新增顶级部门</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box box-default">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="box-header with-border">
                                <div class="col-xs-4">部门名称</div>
                                <div class="col-xs-8">操作</div>
                            </div>
                            <div class="box-body">
                                <volist name="vars.info" id="vi">
                                    <div class="col-xs-12">
                                        <div class="col-xs-12 no-paddding" style="padding:0;">
                                            <div class="col-xs-2 h5 no-padding master-box">
                                                <span class="list-handle">
                                                    <i class="fa fa-minus-circle"></i>
                                                    <span class="master-class class-name">{$vi.name}</span>
                                                </span>
                                            </div>
                                            <div class="col-xs-10 h5" data-id="{$vi.id}" data-name="{$vi.name}" data-level="1">
                                                <span class="col-xs-3 add-two-button add-child-class text-right">新增二级部门</span>
                                                <span class="col-xs-1 edit-button edit-top-button text-right">编辑</span>
                                                <span class="col-xs-1 del-button">删除</span>
                                            </div>
                                        </div>
                                        <div class="pagecategory-line"></div>
                                        <notempty name="vi.children">
                                            <div class="item">
                                                <volist name="vi.children" id="vj">
                                                    <div class="item-child">
                                                        <div class="col-xs-2 h5 class-name">
                                                            <span class="list-handle">
                                                                <i class="fa fa-minus-circle"></i>
                                                                <span class="master-class class-name">{$vj.name}</span>
                                                            </span>
                                                        </div>
                                                        <div class="col-xs-10 h5" data-parent-id="{$vi.id}" data-parent-name="{$vi.name}" data-id="{$vj.id}" data-name="{$vj.name}"  data-level="2">
                                                            <span class="col-xs-3 add-three-button add-child-class text-right">新增三级部门</span>
                                                            <span class="col-xs-1 edit-two-button edit-button text-right">编辑</span>
                                                            <span class="col-xs-1 del-button">删除</span>
                                                        </div>
                                                    </div>
                                                    <div class="pagecategory-line"></div>
                                                    <notempty name="vj.children">
                                                        <div class="item">
                                                            <volist name="vj.children" id="vq">
                                                                <div class="item-child">
                                                                    <div class="col-xs-2 h5 class-name text-center">{$vq.name}</div>
                                                                    <div class="col-xs-10 h5" data-top-parent-name="{$vi.name}" data-parent-id="{$vj.id}" data-parent-name="{$vj.name}"   data-id="{$vq.id}" data-name="{$vq.name}"  data-level="3">
                                                                        <span class="col-xs-2"></span>
                                                                        <span class="col-xs-2 edit-three-button edit-button text-right">编辑</span>
                                                                        <span class="col-xs-2 del-button text-left">删除</span>
                                                                    </div>
                                                                </div>
                                                                <div class="pagecategory-line"></div>
                                                            </volist>
                                                        </div>
                                                    </notempty>
                                                </volist>
                                            </div>
                                        </notempty>
                                    </div>

                                </volist>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section name="content">
        <!--start 添加顶级部门 start-->
        <div class="modal fade add-top-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">添加顶级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-add-top-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 添加顶级部门 end-->
        <!--start 添加二级部门 start-->
        <div class="modal fade add-two-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">新增二级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">顶级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-add-two-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 添加二级部门 end-->
        <!--start 添加三级部门 start-->
        <div class="modal fade add-three-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">新增三级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">顶级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-top-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">上级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-add-three-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 添加三级部门 end-->

        <!--start 修改顶级部门 start-->
        <div class="modal fade edit-top-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">编辑顶级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input id="item-child-val" type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-edit-top-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 修改顶级部门 end-->
        <!--start 修改二级部门 start-->
        <div class="modal fade edit-two-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">编辑二级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">顶级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input id="item-child-val" type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-edit-two-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 修改二级部门 end-->
        <!--start 修改三级部门 start-->
        <div class="modal fade edit-three-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">编辑三级部门</h4>
                    </div>
                    <div class="modal-body" style="overflow: hidden;">
                        <div class="col-xs-3 h5"><span class="pull-right">顶级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-top-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">上级部门:</span></div>
                        <div class="col-xs-9 h5 modal-master-class parent-info">&nbsp;PC端</div>
                        <div class="col-xs-3 h5"><span class="pull-right">部门名称:</span></div>
                        <div class="col-xs-9"><input id="item-child-val" type="text" name="name" class="form-control"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-edit-three-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 修改三级部门 end-->

        <!--start 删除顶级部门 start-->
        <div class="modal fade del-wrap" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">删除部门</h4>
                    </div>
                    <div class="modal-body text-center" style="overflow: hidden;">
                        <span>确认删除该部门？<br><span style="color:red;" class="top-warnning">删除后其下属的所有子部门将都被删除！</span></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left submit-del-button">确认</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--end 删除顶级部门 end-->
    </section>
</block>
<block name="script">
    <script>
    	$(document).ready(function() {
            //添加顶级部门
            $('.add-top-button').click(function(event) {
                $('.add-top-wrap .parent-info').text($(this).parent().attr('data-name'));
                $('.add-top-wrap').modal('show');
            });
            $('.submit-add-top-button').click(function(event) {
                var name = $('.add-top-wrap input[name=name]').val();
                $.ajax({
                    url: '/auth/structure/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:1,
                        parent:0,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });
            //添加二级部门
            $('.add-two-button').click(function(event) {
                $('.add-two-wrap .parent-info').attr('data-parent-id', $(this).parent().attr('data-id'));
                $('.add-two-wrap .parent-info').text($(this).parent().attr('data-name'));
                $('.add-two-wrap').modal('show');
            });
            $('.submit-add-two-button').click(function(event) {
                var parent = $('.add-two-wrap .parent-info').attr('data-parent-id');
                var name = $('.add-two-wrap input[name=name]').val();
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:1,
                        parent:parent,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });
            //添加三级部门
            $('.add-three-button').click(function(event) {
                $('.add-three-wrap .parent-info').attr('data-parent-id', $(this).parent().attr('data-id'));
                $('.add-three-wrap .parent-info').text($(this).parent().attr('data-name'));
                $('.add-three-wrap .parent-top-info').text($(this).parent().attr('data-parent-name'));
                $('.add-three-wrap .parent-info').text($(this).parent().attr('data-name'));
                $('.add-three-wrap').modal('show');
            });
            $('.submit-add-three-button').click(function(event) {
                var parent = $('.add-three-wrap .parent-info').attr('data-parent-id');
                var name = $('.add-three-wrap input[name=name]').val();
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:1,
                        parent:parent,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });

            //编辑顶级部门
            $('.edit-top-button').click(function(event) {
                $('.edit-top-wrap input[name=name]').attr('data-id', $(this).parent().attr('data-id'));
                $('.edit-top-wrap input[name=name]').val($(this).parent().attr('data-name'));
                $('.edit-top-wrap').modal('show');
            });
            $('.submit-edit-top-button').click(function(event) {
                var id = $('.edit-top-wrap input[name=name]').attr('data-id');
                var name = $('.edit-top-wrap input[name=name]').val();
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:2,
                        id:id,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });
            //编辑二级部门
            $('.edit-two-button').click(function(event) {
                $('.edit-two-wrap input[name=name]').attr('data-id', $(this).parent().attr('data-id'));
                $('.edit-two-wrap .parent-info').text($(this).parent().attr('data-parent-name'));
                $('.edit-two-wrap input[name=name]').val($(this).parent().attr('data-name'));
                $('.edit-two-wrap').modal('show');
            });
            $('.submit-edit-two-button').click(function(event) {
                var id = $('.edit-two-wrap input[name=name]').attr('data-id');
                var name = $('.edit-two-wrap input[name=name]').val();
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:2,
                        id:id,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });
            //编辑三级部门
            $('.edit-three-button').click(function(event) {
                $('.edit-three-wrap input[name=name]').attr('data-id', $(this).parent().attr('data-id'));
                $('.edit-three-wrap .parent-info').text($(this).parent().attr('data-parent-name'));
                $('.edit-three-wrap .parent-top-info').text($(this).parent().attr('data-top-parent-name'));
                $('.edit-three-wrap input[name=name]').val($(this).parent().attr('data-name'));
                $('.edit-three-wrap').modal('show');
            });
            $('.submit-edit-three-button').click(function(event) {
                var id = $('.edit-three-wrap input[name=name]').attr('data-id');
                var name = $('.edit-three-wrap input[name=name]').val();
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:2,
                        id:id,
                        name:name
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });

            //删除
            $('.del-button').click(function(event) {
                var level = $(this).parent().attr('data-level');
                if(level == '3'){
                    $('.top-warnning').css('display','none');
                }else{
                    $('.top-warnning').css('display','block');
                }
                $('.del-wrap').attr('data-level', level);
                $('.del-wrap').attr('data-id', $(this).parent().attr('data-id'));
                $('.del-wrap').modal('show');
            });
            $('.submit-del-button').click(function(event) {
                $.ajax({
                    url: '/yy/departmentcontents/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type:3,
                        id:$('.del-wrap').attr('data-id'),
                        level:$('.del-wrap').attr('data-level')
                    }
                })
                .done(function(data) {
                    alert(data.info);
                    if ('1' == data.status) {
                        window.location.href = window.location.href;
                    };
                })
            });

            // 点击子部门隐藏显示
            $('.list-handle').on('click',function(){
                if( $(this).parent().parent().siblings('.item').hasClass('active')){
                    $(this).parent().parent().siblings('.item').removeClass('active');
                    $(this).find('i').removeClass('fa-plus-circle').addClass('fa-minus-circle')
                }else{
                    $(this).parent().parent().siblings('.item').addClass('active');
                    $(this).find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle')
                }
            });
    	});

    </script>
</block>