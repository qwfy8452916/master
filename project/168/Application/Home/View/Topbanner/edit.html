<extend name="Main:baseTemplate" />
<block name="title">
    <title>编辑顶部广告 - 控制台</title>
</block>
<block name="style">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
    <link href="/assets/common/js/plugins/icheck/skins/flat/grey.css?v={:C('STATIC_VERSION')}" rel="stylesheet">
</block>
<block name="content">
    <section class="content-header">
        <h1>编辑轮播</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li class="active"><a href="/advbanner">编辑轮播</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="nav-tabs-custom">
                    <form id="form1" action="" method="POST">
                        <div class="tab-content">
                            <!-- 常规 -->
                            <div class="tab-pane active" id="tab_1">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label for="title">请选择城市</label>
                                        <div class="row">
                                            <div class="col-xs-2">
                                                <select name="city_name" class="select2" id="city_name">
                                                    <option value="">请选择城市</option>
                                                    <volist name="citys" id="vo">
                                                        <if condition="$info['city_id'] EQ $vo['cid'] ">
                                                            <option value="{$vo.cid}" selected>{$vo.cname}</option>
                                                            <else/>
                                                            <option value="{$vo.cid}">{$vo.cname}</option>
                                                        </if>
                                                    </volist>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="title">顶部广告标题设置</label>
                                        <div class="row">
                                            <div class="col-xs-4">
                                                <input type="input" class="form-control" name="title"
                                                       placeholder="请输入顶部广告标题" value="{$info.title}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="title">顶部广告链接</label>
                                        <div class="row">
                                            <div class="col-xs-4">
                                                <input type="input" class="form-control" name="url"
                                                       placeholder="请输入顶部广告链接，请以http://开头" value="{$info.url}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="sort">顶部广告时间</label>
                                        <div class="row">
                                            <div class="col-xs-2"><input type="text" class="form-control datetime"
                                                                         name="start_time" placeholder="开始时间"
                                                                         value="{$info.start_time|default=''|date='Y-m-d H:i:s',###}">
                                            </div>
                                            <div class="col-xs-2"><input type="text" class="form-control datetime"
                                                                         name="end_time" placeholder="结束时间"
                                                                         value="{$info.end_time|default=''|date='Y-m-d H:i:s',###}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="title">启用状态</label>
                                        <div class="row">
                                            <div class="col-xs-2">
                                                <if condition="$info.status EQ '1' || $info.status EQ '' ">
                                                    <input class="icheck" type="radio" name="status" checked="checked"
                                                           value="1"/>&nbsp;&nbsp;启用&nbsp;&nbsp;
                                                    <input class="icheck" type="radio" name="status" value="0"/>&nbsp;&nbsp;停用
                                                    <else/>
                                                    <input class="icheck" type="radio" name="status" value="1"/>&nbsp;&nbsp;启用&nbsp;&nbsp;
                                                    <input class="icheck" type="radio" name="status" value="0"
                                                           checked="checked"/>&nbsp;&nbsp;停用
                                                </if>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="title">上传图片</label>
                                        <div class="row">
                                            <div class="col-xs-6">
                                                <input id="imgUpload" type="file" multiple/>
                                                <input type="hidden" name="img_url" value="{$info.img_url}"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-xs-4">
                                        <div class="alert alert-warning alert-dismissible fade in" role="alert">
                                            <strong>顶部广告尺寸：1920px * 70px</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="title">通栏备注</label>
                                <div class="row">
                                    <div class="col-xs-4">
                                        <textarea class="form-control" placeholder="请输入备注(选填)" name="description">{$info.description}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            <div class="box-footer">
                <input type="hidden" name="edit_id" value="{$info.id}">
                <span id="submit" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;保存</span>
                <button id="but_back" type="button" class="btn btn-default"><i
                        class="fa fa-mail-reply"></i>&nbsp;返回
                </button>
            </div>
            </form>
        </div>
        </div>
        </div>
    </section>
</block>
<block name="script">
    <script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
    <script charset="utf-8" src="{:C('168NEW_URL')}/assets/common/js/bootstrap.autocomplete.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="/assets/common/js/plugins/icheck/icheck.min.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        function compareTime(beginTime,endTime){
            var beginTimes = beginTime.substring(0,10).split('-');
            var endTimes   =  endTime.substring(0,10).split('-');
            beginTime = beginTimes[1]+'-'+beginTimes[2]+'-'+beginTimes[0]+' '+beginTime.substring(10,16);
            endTime    = endTimes[1]+'-'+endTimes[2]+'-'+endTimes[0]+' '+endTime.substring(10,16);
            var a =(Date.parse(endTime)-Date.parse(beginTime))/3600/1000;
            if(a<0){
                return 1;   //endTime小
            }else if (a>0){
                return 2;   //endTime大
            }else if (a==0){
                return 3;   //时间相等
            }
        }


        $('input[name=status]').iCheck({
            checkboxClass: 'icheckbox_flat-grey',
            radioClass: 'iradio_flat-grey',
            increaseArea: '' // optional
        });
        //检测时间
        function checkTime(){
            var start_time = $("input[name=start_time]").val();
            var end_time = $("input[name=end_time]").val();
            //对比促销开始和上架时间
            if(start_time != '' && end_time != ''){
                var r = compareTime(start_time,end_time);
                if(r == '1'){
                    alert('结束时间不能 早于 开始时间！');
                    $("input[name=end_time]").val('');
                }
            }
        }

        $(document).ready(function(){
            $(".datetime").change(function(){
                checkTime();
            });


            $('.datetime').datetimepicker({
                weekStart: 1,
                todayHighlight: 1,
                todayBtn: true,
                format: "yyyy-mm-dd hh:ii:ss",
                minView: 0,
                pickerPosition: "bottom-left",
                autoclose: true,
            });

            $(".select2").select2();

            var mes_count = 0;
            $("#imgUpload").fileinput({
                language: 'zh', //设置语言,
                uploadUrl:"/upload/uploadimg/",
                showCaption:false,
                browseClass:"btn blue",
                allowedFileExtensions : ['jpg','png','gif'],
                maxFileCount:1,
                uploadClass:"btn green",
                removeClass:"btn red",
                uploadAsync:true,
                dropZoneEnabled:false,
                previewSettings:{
                    image: {width: "1920px", height: "70px"}
                },
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
                layoutTemplates:{
                    actionDelete:"",
                    actionUpload:""
                },
                uploadExtraData:{
                    prefix:'qzbanner'
                },
                minImageWidth: "1920",
                minImageHeight: "70",
                maxImageWidth: "1920",
                maxImageHeight: "70",
                maxFileSize:'600',
                initialPreview:'<notempty name="info.img_url"><img src="http://{:C("QINIU_DOMAIN")}/{$info.img_url}" class="file-preview-image"></notempty>',
            }).on('fileuploaded', function(event, data) {
                if(1 == data.response.status){
                    $('input[name=img_url]').val(data.response.data.name);
                }else{
                    alert("上传失败，请重新上传，如多次失败请联系技术部门");
                }
            }).on("fileuploaderror",function(event, data){
                return false;
            }).on("fileclear",function(){
                $("input[name=files]").val("");
            });


            $("#submit").click(function(event){
                if(trim($("select[name=city_name]").val()) === ''){
                    alert("请选择城市~ ");
                    return false;
                }
                if(trim($("input[name=title]").val()) === ''){
                    $("input[name=title]").focus();
                    $("input[name=title]").addClass('focus');
                    alert("请输入顶部广告标题");
                    return false;
                }
                if(trim($("input[name=url]").val()) === ''){
                    $("input[name=url]").focus();
                    $("input[name=url]").addClass('focus');
                    alert("请输入顶部广告链接，请以http://开头");
                    return false;
                }
                if(trim($("input[name=start_time]").val()) === ''){
                    $("input[name=start_time]").focus();
                    $("input[name=start_time]").addClass('focus');
                    alert("请填写开始日期~ ");
                    return false;
                }
                if(trim($("input[name=end_time]").val()) === ''){
                    $("input[name=end_time]").focus();
                    $("input[name=end_time]").addClass('focus');
                    alert("请填写结束日期~ ");
                    return false;
                }
                if($("input[name=img_url]").val() === ''){
                    $("input[name=img_url]").focus();
                    $("input[name=img_url]").addClass('focus');
                    alert("上传图片 ");
                    return false;
                }
                var info = $("#form1").serializeArray();
                $.ajax({
                    url: '/topbanner/edit',
                    type: 'POST',
                    dataType: 'JSON',
                    data: info
                })
                    .done(function (data) {
                        if(data.status == 0){
                            alert(data.info);
                            return
                        }
                        window.location.href = '/topbanner/';
                    })
            });
        });
        //返回
        $('#but_back').on('click',function () {
            if (confirm("确定要离开此页么？")) {
                location.href = "/topbanner/";
            }
        });
    </script>
</block>
