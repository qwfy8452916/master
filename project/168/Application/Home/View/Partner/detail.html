<extend name="Main:baseTemplate" />
<block name="title">
    <title>标识详情 - 控制台</title>
</block>
<block name="style">
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/css/global.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/partner/css/detail.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/daterangepicker/daterangepicker-bs3.css?v={:C('STATIC_VERSION')}" />
    <style>
        .dataTables_filter {display:none}
    </style>
</block>

<block name="content">
    <section class="content-header">
        <div class="row">
            <div class="col-xs-12">
                <div class="box" style="margin-bottom: 0">
                    <div class="box-body act-box" style="min-width:500px;padding: 0">
                        <nav class="nav">
                            <span>合作商管理</span><span>>标识详情</span>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

    </section>
    <section class="content">
    <div class="row">
        <div class="col-xs-12">
        <div class="box">
            <div class="box-body act-box" style="min-width:500px" id="box-head">
                <div class="tiaojian-sel">条件查询</div>
                <form action="" method="get" id="tiaojian">
                        <div class="col-sm-2">
                            <label >渠道标识：</label>
                            <select name="" class="form-control select2" id="select_src">
                                <option value="">全部</option>
                                <volist name="search" id="vo">
                                    <if condition="$vo['src'] eq $map['source_src']">
                                    <option value="{$vo.src}" selected>{$vo.src}</option>
                                    <else/>
                                    <option value="{$vo.src}">{$vo.src}</option>
                                    </if>
                                </volist>

                            </select>
                        </div>
                        <div class="col-sm-2">
                            <label >渠道名称：</label>
                            <select name="state" class="form-control select2" id="select_name">
                                <option value="">全部</option>
                                <volist name="search" id="vo">
                                    <if condition="$vo['name'] eq $map['source_name']">
                                        <option value="{$vo.name}" selected>{$vo.name}</option>
                                     <else/>
                                        <option value="{$vo.name}">{$vo.name}</option>
                                    </if>
                                </volist>
                            </select>
                        </div>
                        <div class="input-group" >
                            <div class="input-group-btn" id="search">
                                <button type="button" class="btn btn-success searchinfo" >查询</button>
                                <button type="button" class="btn btn-success p-biaoshi">添加匹配标识</button>
                            </div>


                        </div>
                </form>
            </div>
        </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box" id="bizoshi-detail">
                <table>
                    <tbody>
                        <tr>
                            <th>渠道标识</th>
                            <th>渠道名称</th>
                            <th>是否付费</th>
                            <th>所需查看数据</th>
                            <th>操作</th>
                        </tr>
                        <volist name="list" id="vi" key="ki">
                            <tr>
                                <td class="source_src">{$vi.src}</td>
                                <td class="source_name">{$vi.name}</td>
                                <td>
                                    {$vi.charge}
                                </td>
                                <td>{$vi.html|default='--'}</td>
                                <td class="b-caozuo">
                                    <a href="javascript:;" class="b-check" data-uv="{$vi.uv_show}" data-ip="{$vi.ip_show}" data-order="{$vi.order_show}" data-real="{$vi.real_order_show}" data-id="{$vi.sid}">设置查看数据</a>
                                    <a href="javascript:;" class="b-del" data-id="{$vi.sid}">删除</a>
                                </td>
                            </tr>
                        </volist>


                    </tbody>
                </table>
                <div class="box-footer clearfix">
                       {$page}
                </div>
            </div>
        </div>
</div>
<!-- 设置查看数据弹框 -->
<div class="check-data">
    <div class="title">
        <span>设置查询数据</span>
        <button class="button button-highlight button-square button-large" id="c-closed"><i class="fa fa-close"></i></button>
    </div>
    <div class="c-bz">渠道标识：<span class="pop_src">zhuli-1</span></div>
    <div class="c-name">渠道名称：<span class="pop_name">微信助力-1</span></div>
    <div class="c-sj">
        <span class="fl">所需查看数据：</span>
        <div class="group group1 fl">
            <input type="checkbox" class="uv_box">
            <span>UV</span>
        </div>
        <div class="group group2 fl">
            <input type="checkbox" class="ip_box"><span>IP</span>
        </div>
        <div class="group group3 fl">
            <input type="checkbox" class="order_box"><span>注册量</span>
        </div>
        <div class="group group4 fl">
            <input type="checkbox" class="real_box"><span>有效注册量</span>
        </div>
    </div>
    <p>注：注册量（对应发单量），有效注册量（对应实际分单量）</p>
    <div class="c-btn">
            <button class="c-bc">保存</button>
            <button class="c-qx">取消</button>
    </div>
</div>
<!-- 匹配标识弹框 -->
<div class="pipei">
    <div class="title">
        <span>匹配标识</span>
        <button class="button button-highlight button-square button-large" id="p-closed"><i class="fa fa-close"></i></button>
    </div>
    <div class="p-name">合作商名称：<span id="nameHzs" >合作商名称</span></div>
    <table class="p-table">
        <tbody id="hsz_tbody">
        <?php
       for ($i = 0; $i < 5; $i++) {?>
        <tr>
            <td width="100">渠道标识：</td>
            <td width="200">
                <select name="dd" id="" class="p-select">
                    <option value="">全部</option>
                    <?php
       foreach($sourceList as $val) {?>
                    <option value="<?php echo $val['id'];?>"><?php echo $val['name'];?></option>
                    <?php } ?>
                </select>
            </td>
            <td width="100">查询数据：</td>
            <td width="100">
                <input type="checkbox"><span class="span">UV</span>
            </td>
            <td width="100">
                <input type="checkbox"><span class="span">IP</span>
            </td>
            <td width="100">
                <input type="checkbox"><span class="span">注册量</span>
            </td>
            <td width="100">
                <input type="checkbox" id="checkbox1"><span class="span1">有效注册量</span>
            </td>
            <td width="100">
                <button class="button button-highlight button-square button-large del-tr"><i class="fa fa-close"></i></button>
            </td>
        </tr>
        <?php } ?>
        </tbody>
    </table>
    <div class="btn-jia">
        <button class="button button-highlight button-square button-large jia-tr"><i class="fa fa-plus"></i></button>
    </div>
    <div class="p-btn">
        <button class="p-qr">保存</button>
        <button class="p-qx">取消</button>
    </div>
    <p class="zhushi">注：注册量（对应发单量），有效注册量（对应实际分单量）</p>
</div>
<!-- 删除弹框 -->
<div class="delete">
    <p>确认删除该渠道标识？</p>
   <div class="d-btn">
        <button class="d-qr">确认</button>
        <button class="d-qx">取消</button>
   </div>
</div>
</section>
</block>
<block name="script">
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
<script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
<link href="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/dataTables.bootstrap.css?v={:C('STATIC_VERSION')}" rel="stylesheet">
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/jquery.dataTables.js?v={:C('STATIC_VERSION')}"></script>
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/dataTables.bootstrap.min.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript" src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
    $('.select2').select2({
        allowClear: true,
        language: "zh-CN"
    });
    $('.p-select').select2({
        allowClear: true,
        language: "zh-CN"
    });
     $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        autoclose: true
    });
    $(document).on('click','.b-check',function(){

        $('.uv_box').removeAttr("checked");
        $('.ip_box').removeAttr("checked");
        $('.order_box').removeAttr("checked");
        $('.real_box').removeAttr("checked");

        var that = $(this);
        var source_src = that.parent().parent().find('.source_src').html();
        var source_name = that.parent().parent().find('.source_name').html();

        if(that.attr('data-uv') == 1){
            $('.uv_box').prop("checked",'checked');
        }
        if(that.attr('data-ip') == 1){
            $('.ip_box').prop("checked",'checked');
        }
        if(that.attr('data-order') == 1){
            $('.order_box').prop("checked",'checked');
        }
        if(that.attr('data-real') == 1){
            $('.real_box').prop("checked",'checked');
        }

        $('.c-bc').attr('data-id',that.attr('data-id'));
        $('.pop_src').html(source_src);
        $('.pop_name').html(source_name);
        $('.check-data').show();

    })

    $('#c-closed').click(function(){
        $('.check-data').hide();
    })
    $('.c-bc').click(function(){
        var that = $(this);
        var sid = $(this).attr('data-id');
//        var data = [];
        var uv = '';
        var ip = '';
        var zhuce = '';
        var real_zhuce = '';
        var checkbox =  that.parent().parent().find('input:checkbox');
        $.each(checkbox,function(i){
            if(i == 0){
                if(this.checked){
                    uv = 1;
                }else{
                    uv = 0;
                }
            }
            if(i == 1){
                if(this.checked){
                    ip = 1;
                }else{
                    ip = 0;
                }
            }
            if(i == 2){
                if(this.checked){
                    zhuce = 1;
                }else{
                    zhuce = 0;
                }
            }
            if(i == 3){
                if(this.checked){
                    real_zhuce = 1;
                }else{
                    real_zhuce = 0;
                }
            }
        });
        var data = [{"sid":sid,"uv":uv,"ip":ip,"zhuce":zhuce,"real_zhuce":real_zhuce}];
        $.ajax({
            url: '/partner/editSource/',
            type: 'POST',
            dataType: 'JSON',
            data:{data:data}
        })
        .done(function(data) {
            if (data.status == '1') {
                alert("修改成功");
                $('.check-data').hide();
                window.location.href = window.location.href;
            } else {

                return false;
            }
        })
        .fail(function(xhr) {
            alert('发生未知错误，请稍后重试~');
            return false;
        })

    })
    $('.c-qx').click(function(){
        $('.check-data').hide();
    })
    // 渠道标识删除
     $('#bizoshi-detail').on('click','.b-del',function(){
        $('.delete').show();
        var _this = $(this);
        var id = _this.attr('data-id');
         $('.d-qr').on('click',function(){
             if($(this).attr("useful") == 1){
                 return false;
             }else{
                 $(this).attr("useful",'1');
                 $.ajax({
                     url: "/partner/delSource",
                     type: 'POST',
                     dataType: 'JSON',
                     data: {
                         id:id
                     }
                 })
                     .done(function(data) {
                         if(data.status == '1'){
                             alert('删除成功');
                             window.location.href = window.location.href;
                         }else{
                             alert(data.info);
                         }
                     })
                     .fail(function(xhr) {
                         alert('操作失败,请稍后重试~');
                     })
             }
         });
         $('.d-qx').on('click',function(){
            $('.delete').hide();
         });

     });

    $('.searchinfo').on('click',function () {
        var src = $('#select_src').val();
        var name = $('#select_name').val();
        window.location.href = '/partner/detail/?id={$id}'+'&source_src='+src+'&source_name='+ name;
    });

    // 显示隐藏标识弹框
    $('.p-biaoshi').click(function() {
        var that = $(this);
        var companyid = '{$company.id}';
        var name =  '{$company.name}';
        $('#nameHzs').attr('data-id',companyid);
        $('#nameHzs').text(name);
        $('.pipei').show();
    });

    $('#p-closed').click(function() {
        $('.pipei').hide();
    });
    $('.p-qx').click(function() {
        $('.pipei').hide();
    });
    //标识 删除
    $('.p-table ').on('click','.del-tr',function(){
        $(this).parent().parent().remove();
    });
    // 添加
    var html = '<tr> <td width="100">渠道标识：</td> <td width="200"> <select name="" id="" class="p-select"> <option value="">全部</option>'+'{$option}'
        +'</select> </td> <td width="100">查询数据：</td><td width="100"> <input type="checkbox" name="uv"><span class="span">UV</span> </td> <td width="100"> <input type="checkbox" name="ip"><span class="span">IP</span></td><td width="100"><input type="checkbox" name="zhuce"><span class="span">注册量</span></td><td width="100"><input type="checkbox" name="real_zhuce" id="checkbox1"><span class="span1">有效注册量</span></td><td width="100"><button class="button button-highlight button-square button-large del-tr"><i class="fa fa-close"></i></button></td></tr>';

    $('.pipei ').on('click','.jia-tr',function(){

        $("#hsz_tbody").append(html).find('select').select2();
    });
    $(document).on('click','.p-qr',function(){
        var jsonData = new Array();
        var companyid = $('#nameHzs').attr('data-id');
        $('#hsz_tbody tr').each(function(i){
            var that = $(this);
            var option = that.find('select').val();
            var checkbox =  that.find('input:checkbox');
            var uv = '';
            var ip = '';
            var zhuce = '';
            var real_zhuce = '';
            $.each(checkbox,function(i){

                if(i == 0){
                    if(this.checked){
                        uv = 1;
                    }else{
                        uv = 0;
                    }
                }
                if(i == 1){
                    if(this.checked){
                        ip = 1;
                    }else{
                        ip = 0;
                    }
                }
                if(i == 2){
                    if(this.checked){
                        zhuce = 1;
                    }else{
                        zhuce = 0;
                    }
                }
                if(i == 3){
                    if(this.checked){
                        real_zhuce = 1;
                    }else{
                        real_zhuce = 0;
                    }
                }
            });
            jsonData.push({"company":companyid,"source":option,"uv":uv,"ip":ip,"zhuce":zhuce,"real_zhuce":real_zhuce});

        })

        $.ajax({
            url: '/partner/addSource/',
            type: 'POST',
            dataType: 'JSON',
            data:{data:jsonData}
        })
            .done(function(data) {
                if (data.status == '1') {
                    alert("添加成功");
                    window.location.href = window.location.href;
                } else {
                    alert(data.info);
                    return false;
                }
            })
            .fail(function(xhr) {
                alert('发生未知错误，请稍后重试~');
                return false;
            })

    })
</script>
</block>