<extend name="Main:baseTemplate" />
<block name="title">
    <title>合作商管理添加 - 控制台</title>
</block>
<block name="style">
<link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{:C('168NEW_URL')}/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/common/css/global.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="{:C('168NEW_URL')}/assets/home/partner/css/add.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/daterangepicker/daterangepicker-bs3.css?v={:C('STATIC_VERSION')}" />
    <style>
        .dataTables_filter {display:none}
    </style>
</block>

<block name="content">
    <section class="content-header">
        <div class="row">
            <div class="col-xs-12">
                <div class="box" style="margin-bottom: 0">
                    <div class="box-body act-box" style="min-width:500px;padding: 0">
                        <nav class="nav">
                            <span>合作商管理</span><span> > <if condition="$edit eq 1">编辑<else />添加</if></span>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

    </section>
    <section class="content">
    <div class="row">
        <div class="col-xs-12">
        <div class="box">
            <div class="box-body act-box" style="min-width:500px" id="box-head">
                <form  id="cooperate-add">
                    <div class="control-group col-sm-6">
                        <label for=""><span class="star">*</span>合作商名称：</label>
                        <input type="text" name="name" value="{$user.name}">
                    </div>
                    <div class="control-group col-sm-6">
                        <label for=""><span class="star">*</span>联系人：</label>
                        <input type="text" name="linkman" value="{$user.linkman}">
                    </div>
                    <div class="control-group col-sm-6">
                        <label for="">简称：</label>
                        <input type="text" name="short" value="{$user.short}">
                    </div>
                    <div class="control-group col-sm-6">
                        <label for="">联系人职位：</label>
                        <input type="text" name="linkposition" value="{$user.linkposition}">
                    </div>
                    <div class="control-group col-sm-6">
                        <label for=""><span class="star">*</span>账号：</label>
                        <if condition="$edit eq 1">
                            <input type="text" name="account" value="{$user.account}" readonly>
                        <else/>
                            <input type="text" name="account">
                        </if>
                    </div>
                    <div class="control-group col-sm-6">
                        <label for=""><span class="star">*</span>联系电话：</label>
                        <input type="text" name="linktel"  value="{$user.linktel}" >
                    </div>
                    <div class="control-group col-sm-6">
                        <label for="" class="fl">注册时间：</label>
                        <input type="text" class="datepicker"  name="join_time"  value="<?php echo !empty($user['join_time'])?date('Y-m-d',$user['join_time']):'';?>">

                    </div>
                    <div class="control-group col-sm-6">
                        <label for="">QQ：</label>
                        <input type="text" name="linkqq"  value="{$user.linkqq}">
                    </div>
                    <div class="control-group col-sm-6 zc-zb">
                        <label for="">注册资本：</label>
                        <input type="text"  name="join_capital"   value="{$user.join_capital}">
                        <span>万</span>
                    </div>
                    <div class="control-group col-sm-6">
                        <label for="">微信：</label>
                        <input type="text" name="linkwx" value="{$user.linkwx}">
                    </div>
                    <div class="control-group col-sm-6 tg-qd">
                        <label for="" class="fl">合作商推广渠道：</label>
                        <textarea name="channel"  cols="40" rows="5">{$user.channel}</textarea>
                    </div>
                    <div class="control-group col-sm-6 beizhu">
                        <label for="" class="fl">备注：</label>
                        <textarea name="remark"  cols="40" rows="5">{$user.remark}</textarea>
                    </div>
                    <div class="control-group col-sm-6">
                        <label for="" class="fl cs-date">测试日期：</label>
                        <input type="text" class="form-control datepicker fl begin"  id="test_starttime" name="test_starttime" value="<?php echo !empty($user['test_starttime'])?date('Y-m-d',$user['test_starttime']):'';?>"><span class="fl jiangegu">&sim;</span>
                        <input type="text" class="form-control datepicker fl end" <?php echo empty($user['test_starttime'])?'disabled':'';?>  id="test_endtime"  name="test_endtime" value="<?php echo !empty($user['test_endtime'])?date('Y-m-d',$user['test_endtime']):'';?>">

                    </div>
                    <div class="control-group col-sm-6">
                        <label for="">对接人：</label>
                        <select name="yy_id" class="form-control select2" >
                                <option value="">请选择</option>
                                <volist name="buttman" id="vo">
                                    <if condition="$user['yy_id'] eq $vo['id']">
                                        <option value="{$vo.id}" selected>{$vo.uname}</option>
                                    <else/>
                                        <option value="{$vo.id}" >{$vo.uname}</option>
                                    </if>

                                </volist>


                        </select>
                    </div>
                    <div class="control-group col-sm-12">
                        <label for="" class="fl hz-date">合作日期：</label>
                        <input type="text" class="form-control datepicker fl begin" id="cooperate_starttime" name="cooperate_starttime" value="<?php echo !empty($user['cooperate_starttime'])?date('Y-m-d',$user['cooperate_starttime']):'';?>"><span class="fl jiangegu">&sim;</span>
                        <input type="text" class="form-control datepicker fl end" <?php echo empty($user['cooperate_starttime'])?'disabled':'';?>  id="cooperate_endtime" name="cooperate_endtime"  value="<?php echo !empty($user['cooperate_endtime'])?date('Y-m-d',$user['cooperate_endtime']):'';?>">
                    </div>
                    <div class="control-group col-sm-12">
                        <label for="" class="fl hz-ms"><span class="star">*</span>合作模式：</label>
                        <select name="cooperate_mode" class="form-control fl" data-value="{$user.cooperate_mode}" id="mode">
                            <option value="">请选择</option>
                            <option value="1" <?php if($user['cooperate_mode'] == 1){echo 'selected';}?>>CPA</option>
                            <option value="2" <?php if($user['cooperate_mode'] == 2){echo 'selected';}?>>CPT</option>
                            <option value="3" <?php if($user['cooperate_mode'] == 3){echo 'selected';}?>>CPM</option>
                            <option value="4" <?php if($user['cooperate_mode'] == 4){echo 'selected';}?>>CPC</option>
                            <option value="5" <?php if($user['cooperate_mode'] == 5){echo 'selected';}?>>CPD</option>
                            <option value="6" <?php if($user['cooperate_mode'] == 6){echo 'selected';}?>>CPS</option>
                            <option value="7" <?php if($user['cooperate_mode'] == 7){echo 'selected';}?>>免费</option>
                        </select>
                    </div>
                    <div class="control-group col-sm-12">
                        <label for="" class="fl jk-fs">结款方式：</label>
                        <select name="pay_mode" class="form-control fl"  data-value="{$user.pay_mode}" id="pay_mode">
                            <option value="">请选择</option>
                            <if condition = '$user.cooperate_mode neq 7'>
                            <option value="1" <?php if($user['pay_mode'] == 1){echo 'selected';}?>>预付</option>
                            <option value="2" <?php if($user['pay_mode'] == 2){echo 'selected';}?>>周结</option>
                            <option value="3" <?php if($user['pay_mode'] == 3){echo 'selected';}?>>半月结</option>
                            <option value="4" <?php if($user['pay_mode'] == 4){echo 'selected';}?>>月结</option>
                            </if>
                        </select>
                    </div>
                    <div class="control-group col-sm-12">
                        <label for="">合作价格：</label>
                        <input type="text" name="cooperate_price" value="{$user.cooperate_price}">
                    </div>
                    <div class="control-group col-sm-12 hz-lj">
                        <label for="" class="fl">合作链接：</label>
                        <textarea name="cooperate_link" id="" cols="40" rows="5" placeholder="一行填写一个链接末尾以英文版“;”结尾">{$user.cooperate_link}</textarea>
                    </div>
                    <div class=" col-sm-12 yy-zz">
                        <label for="" class="fl">营业执照：</label>
                        <div class="upload">
                            <input type="hidden" name="licence_logo" id="licence_logo" value="{$user.licence_logo}"><!--{$user.licence_logo}-->
                            <input type="file" class="licence" id="licence" multiple>
                        </div>

                            <!--<span class="fr">重新上传</span>-->
                        <!--</a>-->

                    </div>
                    <if condition="$edit eq 1">
                        <input type="hidden" name="editId" value="{$user.id}" id="editId">
                        <div class="fl btn-save btn-edit"><button type="button" >保存</button></div>
                        <else />
                        <div class="fl btn-save btn-add"><button type="button" >保存</button></div>
                    </if>



                    <div class="fl btn-qx"><button type="button" >取消</button></div>
                </form>

            </div>
        </div>
        </div>
    </div>

</section>
</block>
<block name="script">
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/select2/select2.js?v={:C('STATIC_VERSION')}"></script>
<script src="{:C('168NEW_URL')}/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
<link href="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/dataTables.bootstrap.css?v={:C('STATIC_VERSION')}" rel="stylesheet">
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/jquery.dataTables.js?v={:C('STATIC_VERSION')}"></script>
<script src="{:C('168NEW_URL')}/assets/common/js/plugins/dataTables/dataTables.bootstrap.min.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript" src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
    $('.select2').select2({
        allowClear: true,
        language: "zh-CN"
    });
     $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        autoclose: true
    });
     $('.p-select').select2({
        allowClear: true,
        language: "zh-CN"
    });


    $('.btn-qx').click(function(event){
        window.location.href = '/partner/index/';
    })

    $("#test_starttime").change(function(event){

        if($(this).val()!=''){
            $("#test_endtime").removeAttr("readonly");
        }else{
            $("#test_endtime").val('');
            $("#test_endtime").attr("readonly");
        }

    })

    $("#cooperate_starttime").on('change',function(event){

        if($(this).val()!=''){


            $("#cooperate_endtime").removeAttr("readonly");
            $("#cooperate_endtime").removeAttr("disabled");
        }else{

            $("#cooperate_endtime").val('');
            $("#cooperate_endtime").attr("readonly",true);
            $("#cooperate_endtime").attr("disabled",true);

        }

    })

    $("#test_starttime").on('change',function(event){

        if($(this).val()!=''){
            $("#test_endtime").removeAttr("readonly");
            $("#test_endtime").removeAttr("disabled");

        }else{
            $("#test_endtime").val('');
            $("#test_endtime").attr("readonly",true);
            $("#test_endtime").attr("disabled",true);
        }

    })


    //新增
    $('.btn-add').on('click',function(){
        var info = $("#cooperate-add").serializeArray();
//        console.log(info);return;
        var name = trim($('input[name=name]').val());
        var account =  trim($('input[name=account]').val());
        var linkman =  trim($('input[name=linkman]').val());
        var cooperate_mode = trim($('select[name=cooperate_mode]').val());
        var pay_mode = trim($('select[name=pay_mode]').val());
        var linktel = trim($('input[name=linktel]').val());
        var join_capital = trim($('input[name=join_capital]').val());
        var test_starttime = $('input[name=test_starttime]').val();
        var test_endtime = $('input[name=test_endtime]').val();
        var cooperate_starttime = $('input[name=cooperate_starttime]').val();
        var cooperate_endtime = $('input[name=cooperate_endtime]').val();
        var cooperate_price = trim($('input[name=cooperate_price]').val());
        if(name == ''){
            alert("合作商名称不能为空！");
            $('input[name=name]').focus();
            return false;
        }

        if(account == ''){
            alert("合作商账号不能为空！");
            $('input[name=account]').focus();
            return false;
        }

        if(join_capital != ''){
            var reg=/(^[1-9]{1}[0-9]*$)|(^[0-9]*\.[0-9]{2}$)/;
            if(!reg.test(join_capital)){
                alert("注册资本请输入大于0的整数或者保留两位小数");
                return false;
            }
        }

        if(test_starttime == ''){
            test_endtime = '';
        }
        if(cooperate_starttime == ''){
            cooperate_endtime = '';
        }

        if((test_starttime != '') && (test_endtime!='')){
            if(test_starttime>test_endtime){
                alert("测试结束时间不得早于测试开始时间");
                return false;
            }
        }
        if((cooperate_starttime!='')&&(cooperate_endtime!='')){
            if(cooperate_starttime>cooperate_endtime){
               alert("合作结束时间不得早于合作开始时间");
                return false;
            }
        }
        if((test_endtime!='')&&(cooperate_starttime!='')){
            if(test_endtime>=cooperate_starttime){
                alert("合作日期不得早于测试日期");
                return false;
            }
        }
        if((test_starttime!='')&&(cooperate_starttime!='')){
            if(cooperate_starttime<=test_starttime){
                alert("合作日期不得早于测试日期");
                return false;
            }
        }

        if(cooperate_mode == '') {
            alert("合作模式不能为空！");
            return false;
        }else{
            if(cooperate_mode!=7){
                if(pay_mode == ''){
                    alert("该合作模式下的结款方式不能为空！");
                    return false;
                }
            }
        }


//        if(cooperate_price != ''){
//            var reg=/(^[1-9]{1}[0-9]*$)|(^[0-9]*\.[0-9]{2}$)/;
//            if(!reg.test(cooperate_price)){
//                alert("合作价格请输入大于0的整数或者保留两位小数");
//                return false;
//            }
//        }

        if(linkman == '') {
            alert("联系人不能为空！");
            $('input[name=linkman]').focus();
            return false;
        }
        //验证联系人
        var re = /^[0-9]+(.[0-9]{1,2})?$/gi;
        if (re.test(linkman)) {
            alert('亲，请填写正确的联系人！');
            return false;
        }

        if(linktel == '') {
            alert("联系电话不能为空！");
            $('input[name=linktel]').focus();
            return false;
        }

        //验证手机号
//        var reg = new RegExp("" +
//            "^(130|131|132|155|156|185|186|145|176|175" +
//            "|139|138|137|136|135|134|147|150|151|152|157|158|159|178|182|183|184|187|188" +
//            "|133|153|177|173|180|181|189)[0-9]{8}$");
//        if (!linktel.match(reg)) {
//            alert("请填写正确的手机号码");
//            return false;
//        }

        $.ajax({
            url: '/partner/addajax/',
            type: 'POST',
            dataType: 'JSON',
            data:info
        })
        .done(function(data) {
            if (data.status == '1') {
                alert("添加成功");
                window.location.href = '/partner/index/';
            } else {
                alert(data.info);
                return false;
            }
        })
        .fail(function(xhr) {
            alert('发生未知错误，请稍后重试~');
            return false;
        })
        //0512- 878787 89
    });
    //编辑
    $('.btn-edit').on('click',function(){
        var info = $("#cooperate-add").serializeArray();
        var name = $('input[name=name]').val();
        var account = $('input[name=account]').val();
        var linkman = $('input[name=linkman]').val();
        var cooperate_mode = $('select[name=cooperate_mode]').val();
        var pay_mode = $('select[name=pay_mode]').val();
        var linktel = $('input[name=linktel]').val();
        var join_capital = trim($('input[name=join_capital]').val());
        var test_starttime = $('input[name=test_starttime]').val();
        var test_endtime = $('input[name=test_endtime]').val();
        var cooperate_starttime = $('input[name=cooperate_starttime]').val();
        var cooperate_endtime = $('input[name=cooperate_endtime]').val();
        var cooperate_price = trim($('input[name=cooperate_price]').val());

        if(name == ''){
            alert("合作商名称不能为空！");
            $('input[name=name]').focus();
            return false;
        }

        if(account == ''){
            alert("合作商账号不能为空！");
            $('input[name=account]').focus();
            return false;
        }

        if(join_capital != ''){
            var reg=/(^[1-9]{1}[0-9]*$)|(^[0-9]*\.[0-9]{2}$)/;
            if(!reg.test(join_capital)){
                alert("注册资本请输入大于0的整数或者保留两位小数");
                return false;
            }
        }

        if(test_starttime == ''){
            test_endtime = '';
        }
        if(cooperate_starttime == ''){
            cooperate_endtime = '';
        }

        if((test_starttime != '') && (test_endtime!='')){
            if(test_starttime>test_endtime){
                alert("测试结束时间不得早于测试开始时间");
                return false;
            }
        }
        if((cooperate_starttime!='')&&(cooperate_endtime!='')){
            if(cooperate_starttime>cooperate_endtime){
                alert("合作结束时间不得早于合作开始时间");
                return false;
            }
        }
        if((test_endtime!='')&&(cooperate_starttime!='')){
            if(test_endtime>=cooperate_starttime){
                alert("合作日期不得早于测试日期");
                return false;
            }
        }
        if((test_starttime!='')&&(cooperate_starttime!='')){
            if(cooperate_starttime<=test_starttime){
                alert("合作日期不得早于测试日期");
                return false;
            }
        }

        if(cooperate_mode == '') {
            alert("合作模式不能为空！");
            return false;
        }else{
            if(cooperate_mode!=7){
                if(pay_mode == ''){
                    alert("该合作模式下的结款方式不能为空！");
                    return false;
                }
            }
        }


//        if(cooperate_price != ''){
//            var reg=/(^[1-9]{1}[0-9]*$)|(^[0-9]*\.[0-9]{2}$)/;
//            if(!reg.test(cooperate_price)){
//                alert("合作价格请输入大于0的整数或者保留两位小数");
//                return false;
//            }
//        }

        if(linkman == '') {
            alert("联系人不能为空！");
            $('input[name=linkman]').focus();
            return false;
        }
        //验证联系人
        var re = /^[0-9]+(.[0-9]{1,2})?$/gi;
        if (re.test(linkman)) {
            alert('亲，请填写正确的联系人！');
            return false;
        }

        if(linktel == '') {
            alert("联系电话不能为空！");
            $('input[name=linktel]').focus();
            return false;
        }

        //验证手机号
//        var reg = new RegExp("" +
//            "^(130|131|132|155|156|185|186|145|176|175" +
//            "|139|138|137|136|135|134|147|150|151|152|157|158|159|178|182|183|184|187|188" +
//            "|133|153|177|173|180|181|189)[0-9]{8}$");
//        if (!linktel.match(reg)) {
//            alert("请填写正确的手机号码");
//            return false;
//        }

        $.ajax({
            url: '/partner/addajax/',
            type: 'POST',
            dataType: 'JSON',
            data:info
        })
            .done(function(data) {
                if (data.status == '1') {
                    alert("编辑成功");
                    window.location.href = '/partner/index/';
                } else {
                    alert(data.info);
                    return false;
                }
            })
            .fail(function(xhr) {
                alert('发生未知错误，请稍后重试~');
                return false;
            })
        //0512- 878787 89
    });

    $('#mode').change(function(){
        var mode=$(this).children('option:selected').val();
        if(mode == 7){
            $('#pay_mode').html("<option value=''></option>");
        }else{
            $('#pay_mode').html("<option value=''>请选择</option><option value='1'>预付</option><option value='2'>周结</option><option value='3'>半月结</option><option value='4'>月结</option>");
        }
    });

    $("#licence").fileinput({
        language: 'zh', //设置语言,
        uploadUrl:"/upload/uploadimg/",
        showCaption: false,
        browseClass:"btn btn-primary",
        allowedFileExtensions : ['jpg','png','gif'],
        maxFileCount: 1,
        uploadClass:"btn btn-info",
        removeClass:"btn btn-danger",
        uploadAsync: true,
        dropZoneEnabled:false,
        uploadExtraData: {
            prefix:'hzs_licence_logo',
            chars:'true'
        },
        maxFileSize:1000000000,
        previewSettings:{
            image: {width: "323px", height: "164px"}
        },
        <notempty name='user.licence_logo'>
        initialPreview:[
            "<img src='http://{:C('QINIU_DOMAIN')}/{$user.licence_logo}' class='file-preview-image' >"
        ],
       </notempty>
    }).on('fileuploaded', function(event, data, id, index) {
        if(1 == data.response.status){
            $('#licence_logo').val(data.response.data.name);
        }else{
            alert(data.response.info);
            return false;
        }
    }).on("fileuploaderror",function(event, data){
        alert('文件上传失败,请检查文件格式，规格是否符合要求！')
        return false;
    }).on("fileclear",function(){
        $("#licence_logo").val("");
        $(".img-upload .fileinput-upload-button").removeClass('disabled');
    });

</script>
</block>
