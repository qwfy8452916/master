<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="keywords" content="用户中心">
    <meta name="description" content="用户中心">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>用户中心-齐装网</title>
    <include file="Index:resource" />
    <include file="Designer:resource" />
    <script type="text/javascript" src="{$static_host}/assets/common/js/laydate.js?v={:C('STATIC_VERSION')}"></script>
    <link href="{$static_host}/assets/user/designercase/css/de-blog.css?v={:C('STATIC_VERSION')}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{$static_host}/assets/user/cases/css/jia-suggest.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="{$static_host}/assets/common/js/baidu/uploader/dist/webuploader.css?v={:C('STATIC_VERSION')}">
    <link href="{$static_host}/assets/common/js/baidu/css/upload.css?v={:C('STATIC_VERSION')}" rel="stylesheet" type="text/css" />
    <link href="{$static_host}/assets/common/js/baidu/css/caseup.css?v={:C('STATIC_VERSION')}" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="{$static_host}/assets/common/js/baidu/uploader/dist/webuploader.js?v={:C('STATIC_VERSION')}"></script>
    <script charset="utf-8" src="{$static_host}/assets/common/js/baidu/uploader/upload.js?v={:C('STATIC_VERSION')}"></script>
    <script charset="utf-8" src="{$static_host}/assets/common/js/jquery.dragsort.js?v={:C('STATIC_VERSION')}"></script>

</head>

<body>
    <include file="Designer:header" />
    <div class="ht-wrap oflow">
        <include file="Designer:desnavleft" />
        <div class="yh-main">
            <h1 class="yh-tit">发布作品</h1>
            <form id="myForm" onsubmit="return false;">
            <ul class="ht-moreinfo">
                <li>
                    <span><i class="red">*</i>案例类型：</span>
                    <select name="class" class="select">
                        <volist name="info.class" id="vo">
                            <if condition="$info['case'] AND $info['case']['classid'] EQ $vo['value']">
                            <option value="{$vo.value}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.value}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                </li>
                <li>
                    <span><i class="red">*</i>所在区域：</span>
                    <select name="cs" class="select">
                        <option value="{$info.citys.shen.id}">{$info.citys.shen.oldname}</option>
                    </select>
                    <select name="qx" class="select">
                        <volist name="info.citys.shi" id="vo">
                            <if condition="$info['case'] AND $info['case']['qx'] EQ $vo['qz_areaid']">
                            <option value="{$vo.qz_areaid}" selected="selected">{$vo.oldName}</option>
                            <else/>
                            <option value="{$vo.qz_areaid}">{$vo.oldName}</option>
                            </if>
                        </volist>
                    </select>
                </li>
                <div class="gover_search">
                    <div class="gover_search_form clearfix">
                            <span><i class="red">*</i>小区名称：</span>
                            <input name="xiaoqu" type="text" id="gover_search_key" placeholder="小区" value="{$info.case.title}"lang="default">
                            <i class="gray">
                                <i class="icon-info-sign mr10"></i>为该案例命名，使用小区、楼盘名称，最好输入提示小区
                            </i>
                            <i class="red err-tips"></i>
                            <div class="search_suggest" id="gov_search_suggest">
                                <ul></ul>
                            </div>
                    </div>
                </div>
                <li>
                    <span><i class="red">*</i>户型结构：</span>
                    <select name="huxing" class="select">
                        <volist name="info.huxing" id="vo">
                            <if condition="$info['case'] AND $info['case']['huxing'] EQ $vo['id']">
                            <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.id}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                    <select name="shi">
                        <volist name="info.shi" id="vo">
                            <if condition="$info['case'] AND $info['case']['shi'] EQ $vo">
                            <option value="{$vo}" selected="selected">{$vo}</option>
                            <else/>
                            <option value="{$vo}">{$vo}</option>
                            </if>
                        </volist>
                    </select>
                    室
                    <select name="ting">
                        <volist name="info.ting" id="vo">
                            <if condition="$info['case'] AND $info['case']['ting'] EQ $vo">
                            <option value="{$vo}" selected="selected">{$vo}</option>
                            <else/>
                            <option value="{$vo}">{$vo}</option>
                            </if>
                        </volist>
                    </select>
                    厅
                    <select name="wei">
                        <volist name="info.wei" id="vo">
                            <if condition="$info['case'] AND $info['case']['wei'] EQ $vo">
                            <option value="{$vo}" selected="selected">{$vo}</option>
                            <else/>
                            <option value="{$vo}">{$vo}</option>
                            </if>
                        </volist>
                    </select>
                    卫
                </li>
                <li style="display:none;">
                    <span><i class="red">*</i>房屋类型：</span>
                    <select name="leixing" class="select">
                        <volist name="info.leixing" id="vo">
                            <if condition="$info['case'] AND $info['case']['lx'] EQ $vo['id']">
                            <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.id}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                </li>
               <!--  <li>
                    <span>装修方案：</span>
                     <select name="fangshi" class="select">
                        <volist name="info.fangshi" id="vo">
                            <if condition="$info['case'] AND $info['case']['fs'] EQ $vo['id']">
                            <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.id}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                </li> -->
                <li>
                    <span><i class="red">*</i>房屋面积：</span>
                    <input name="mianji" type="text" placeholder="面积" value="{$info.case.mianji}">
                    <i class="gray">
                        <i class="icon-info-sign mr10"></i>面积请使用整数
                    </i>
                    <i class="red err-tips"></i>
                </li>
                <li>
                    <span><i class="red">*</i>装修风格：</span>
                    <select name="fengge" class="select">
                        <volist name="info.fengge" id="vo">
                            <if condition="$info['case'] AND $info['case']['fengge'] EQ $vo['id']">
                            <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.id}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                </li>
                <li>
                    <span><i class="red">*</i>合同造价：</span>
                     <select name="zaojia" class="select">
                         <volist name="info.jiage" id="vo">
                            <if condition="$info['case'] AND $info['case']['jiage'] EQ $vo['id']">
                            <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                            <else/>
                            <option value="{$vo.id}">{$vo.name}</option>
                            </if>
                        </volist>
                    </select>
                </li>
                <li>
                    <span>装修时间：</span>
                    <i id="ht-date">
                    <input id="start" name="start" class="laydate-icon" placeholder="请选择开始日期" value="{$info.case.start}">
                     到 <input id="end" name="end" class="laydate-icon" placeholder="请选择结束日期"  value="{$info.case.end}">
                    </i>
                </li>
                <li>
                    <span><i class="red">*</i>案例描述：</span>
                    <textarea class="jianjiemain" placeholder="案例描述" name="text" >{$info.case.text}</textarea>
                    <p>
                        <i class="red" style="margin-left:90px;">
                            <i class="icon-info-sign mr10"></i>请尽量填写该案例的详细描述，方便业主全方位的了解您的公司
                        </i>
                    </p>
                </li>
                <li>
                    <span><i class="red">*</i>案例图片：</span>
                    <div class="ht-comp-phot">
                        <div id="uploader" class="uploader" data-data='{$info.case.imgs}'>
                        </div>
                    </div>
                    <input type="hidden" name="imgs"/>
                </li>
            </ul>
            <div class="ht-yes">
                <ul class="red">
                    <li> 1、带*为必填项</li>
                    <li> 2、案例信息、图片上,请勿包含 联系方式\网址\其他网站LOGO\微博、微信帐号\二维码 等"相关联系方式",否则将会封号处理。</li>
                    <li> 3、请上传高清优质图片，齐装网会重点推荐高清优质的图片，增加您的曝光率，像素底质量差的图片将审核不通过。</li>
                    <li> 4、图片展示最佳的尺寸宽为 <em style="font-size:16px;">660</em> 像素,最大尺寸为 <em style="font-size:16px;">860</em> 像素,最小尺寸为 <em style="font-size:16px;">460</em> 像素</li>
                </ul>
                <button id="btnSave" class="mt20" type="button">
                <i class="icon-ok mr10"></i>提交</button>
                <input name="caseid" type="hidden" value="{$info.case.id}"/>
                <i class="red err-tips"></i>
            </div>
            </form>
        </div>
    </div>
    <include file="Index:footer" />
</body>

<script type="text/javascript">
//实现搜索输入框的输入提示js类
function oSearchSuggest(searchFuc){
    var input = $('#gover_search_key');
    var suggestWrap = $('#gov_search_suggest');
    var key = "";
    var init = function(){
        input.bind('keyup',sendKeyWord);
        input.bind('blur',function(){setTimeout(hideSuggest,500);})
    }
    var hideSuggest = function(){
        suggestWrap.hide();
    }

    //发送请求，根据关键字到后台查询
    var sendKeyWord = function(event){

        //键盘选择下拉项
        if(suggestWrap.css('display')=='block'&&event.keyCode == 38||event.keyCode == 40){
            var current = suggestWrap.find('li.hover');
            if(event.keyCode == 38){
                if(current.length>0){
                    var prevLi = current.removeClass('hover').prev();
                    if(prevLi.length>0){
                        prevLi.addClass('hover');
                        input.val(prevLi.html());
                        input.attr("lang",prevLi.attr('lang'));
                    }
                }else{
                    var last = suggestWrap.find('li:last');
                    last.addClass('hover');
                    input.val(last.html());
                    input.attr("lang",last.attr('lang'));
                }

            }else if(event.keyCode == 40){
                if(current.length>0){
                    var nextLi = current.removeClass('hover').next();
                    if(nextLi.length>0){
                        nextLi.addClass('hover');
                        input.val(nextLi.html());
                        input.attr("lang",nextLi.attr('lang'));
                    }
                }else{
                    var first = suggestWrap.find('li:first');
                    first.addClass('hover');
                    input.val(first.html());
                    input.attr("lang",first.attr('lang'));
                }
            }

        //输入字符
        }else{
            var valText = $.trim(input.val());
            if(valText ==''||valText==key){
                return;
            }
            searchFuc(valText);
            key = valText;
        }

    }
    //请求返回后，执行数据展示
    this.dataDisplay = function(data,ids){
        if(data.length<=0){
            suggestWrap.hide();
            return;
        }

        //往搜索框下拉建议显示栏中添加条目并显示

        suggestWrap.find('ul').html('');
        for(var i=0; i<data.length; i++){
            var li = $('<li></li>');
            li.attr("lang",ids[i]);
            li.html(data[i]);
            suggestWrap.find('ul').append(li);
        }

        suggestWrap.show();
        //为下拉选项绑定鼠标事件
        suggestWrap.find('li').hover(function(){
                suggestWrap.find('li').removeClass('hover');
                $(this).addClass('hover');

            },function(){
                $(this).removeClass('hover');
        }).bind('click',function(){
            input.attr("lang",$(this).attr('lang'));
            input.val(this.innerHTML);
            suggestWrap.hide();
        });
    }
    init();
};

//实例化输入提示的JS,参数为进行查询操作时要调用的函数名
var searchSuggest =  new oSearchSuggest(sendKeyWordToBack);
function sendKeyWordToBack(keyword){
    var obj = {
        "keyword" : keyword
    };
    $.ajax({
        url: '/getjias/',
        type: 'GET',
        dataType: 'JSON',
        data: obj
    })
    .done(function(data) {
        if(data.status == 1){
            //如果搜索出为空，则小区lang为空
            if(data.info == '0'){
                $("input[name=xiaoqu]").removeAttr('lang');
            }
            var datas = data.data;
            var aData = [];
            var ids = [];
            $.each(datas,function(name,value) {
                if(value!=""){
                    ids.push(value.id);
                    aData.push(value.name);
                }
            });
            //将返回的数据传递给实现搜索输入框的输入提示js类
            searchSuggest.dataDisplay(aData,ids);
        }
    })
}
</script>







<script type="text/javascript">
    laydate({
        elem: '#ht-date',
        event: 'focus'
    });

    //绑定元素
    //日期范围限制
      var start = {
          elem: '#start',
          format: 'YYYY-MM-DD',
          max: '{:date("Y-m-d")}', //最大日期
          istime: true,
          istoday: false
      };

      var end = {
          elem: '#end',
          format: 'YYYY-MM-DD',
          min: laydate.now(),
          istime: true,
          istoday: false,
          choose: function(datas) {
              start.max = datas; //结束日选好后，充值开始日的最大日期
          }
      };
      laydate(start);
      laydate(end);

      $(".ht-comp-phot").uploader({
            host:"{:C('QINIU_DOMAIN')}",
            old_host:"{:C('STATIC_HOST1')}",
            server:"/uploader/",
            drag:true,
            formData:{
                prefix:"sjscase"
            },
            removePath:"/removedesImg/",
            callback:function(res){
                var data =  $("input[name=imgs]").data("data");
                if(typeof data == "undefined"){
                    data = [];
                }
                img = {
                    id:res["id"],
                    img:res.data["hash"],
                    path:res.data["key"],
                    tabIndex:res.tabIndex
                }
                data.push(img);
                $("input[name=imgs]").data("data",data);
            }
      });

      $("select[name=class]").change(function(event) {
        $("select[name=leixing]").parent().hide();
        $("select[name=huxing]").parent().hide();

        if($(this).val() == 2){
            $("select[name=leixing]").parent().show();
        }else{
            $("select[name=huxing]").parent().show();
        }
     });

      $("#btnSave").click(function(event) {
            var _this = $(this);
            $(".err-tips").html("");
            $(".focus").removeClass('focus');
            if(!App.validate.run($("input[name=xiaoqu]").val())){
                $("input[name=xiaoqu]").addClass('focus');
                $("input[name=xiaoqu]").focus();
                $("input[name=xiaoqu]").parent().find(".err-tips").html("请填写案例小区");
                return false;
            }

            if(!App.validate.run($("input[name=mianji]").val())){
                $("input[name=mianji]").addClass('focus');
                $("input[name=mianji]").focus();
                $("input[name=mianji]").parent().find(".err-tips").html("请填写面积");
                return false;
            }

            if(!App.validate.run($("input[name=mianji]").val(),"decimal")){
                $("input[name=mianji]").addClass('focus');
                $("input[name=mianji]").focus();
                $("input[name=mianji]").parent().find(".err-tips").html("无效的面积");
                return false;
            }

            var imgData = $("input[name=imgs]").data("data");

            if($("input[name=caseid]") == "" && typeof imgData == "undefined"){
                $(".ht-comp-phot").find(".uploader-info").html("请上传案例图片");
                return false;
            }

            var data = $("#myForm").serializeArray();
            var xiaoquid = $("input[name=xiaoqu]").attr('lang');
            data.push({name:"xiaoquid",value:xiaoquid});
            var imgs = [];
            $(".ht-comp-phot li").each(function(){
                var li = $(this);
                if(typeof li.attr("data-id") != "undefined"){
                    imgs.push({
                        id:li.attr("data-id"),
                        index:li.attr("tabIndex"),
                        on:li.hasClass("img_on")?2:0
                    });
                }
            });
            data.push({name:"imgs",value:JSON.stringify(imgs)});

            if(typeof imgData != "undefined"){
                for(var i = 0; i< imgData.length;i++ ){
                    var index = $("#"+imgData[i].id).attr("tabIndex");
                    imgData[i].tabIndex = index;
                    imgData[i].on = typeof $("#"+imgData[i].id).attr("data-on") =="undefined"?0:2;
                }
                data.push({name:"newData",value:JSON.stringify(imgData)});
            }
            _this.attr("disabled","disabled");
            $.ajax({
                url: '/descaseup/',
                type: 'POST',
                dataType: 'JSON',
                data: data
            })
            .done(function(data) {
                if(data.status == 1){
                    window.location.href="/success/descases/"+data.info;
                }else{
                    $(".ht-yes").find(".err-tips").html(data.info);
                    _this.attr("disabled",false);
                }
            })
            .fail(function(xhr) {
                 _this.attr("disabled",false);
                 $(".ht-yes").find(".err-tips").html("上传案例操作失败,请刷新再试！");
            });
      });

</script>
</html>
