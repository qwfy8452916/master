<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="keywords" content="{$keys.keywords}">
    <meta name="description" content="{$keys.description}">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>{$keys.title}-{$title}</title>
    <include file="Index:resource" />
    <include file="Home:resource" />
    <link rel="stylesheet" href="{$static_host}/assets/user/orders/css/ht-order.css?v={:C('STATIC_VERSION')}">
</head>

<body>
    <include file="Home:header" />
    <div class="ht-wrap oflow ht-relative">
        <include file="Home:comnavleft" />
        <include file="Orders:header" />
        <div class="ht-main">
            <if condition="$info['user']['safe_account']">
            <form id="myForm" onsubmit="return false;">
            <ul class="compinfo-secret">
                <li><span>设置新密码：</span>
                    <input name="password" type="password">
                </li>
                <li><span>重复新密码：</span>
                    <input name="confirmpassword" type="password">
                </li>

                <li><span>图形验证码：</span>
                    <input type="text" placeholder="右侧验证码" name="verifyCode"  /><img src="/verify" style="vertical-align:middle;cursor:pointer" class="verifyimg" title="点击更换验证码">
                    <em class="red err-tips"></em>
                </li>

                <li><span>验证码：</span>
                    <input name="code" type="text">
                    <button id="btnSend">发送验证码至手机/邮箱</button>
                </li>
                <li>
                  <div class="ht-tips red"></div>
                </li>
            </ul>
            </form>
            <div class="ht-yes mt20"><a  href="javascript:void(0)" ><i class="icon-ok mr10"></i>确认修改</a> <input class="order_safecode" type="hidden" /></div>
            <else/>
            <p class="ht-info">请先绑定您的安全手机/安全邮箱 <a href="/home/" class="red">点击进入</a></p>
            </if>
        </div>
    </div>
    <include file="Index:footer" />
</body>
<script type="text/javascript">
  $(function(){
     $(".verifyimg").click(function(event) {
        $(this).attr("src","/verify?rand="+Math.random());
    });

    $(".compinfo-secret #btnSend").click(function(event) {
        //先验证图形验证码
          if(!App.validate.run($(".compinfo-secret input[name=verifyCode]").val())){
              $(".compinfo-secret input[name=verifyCode]").addClass('focus').focus().parent().find(".err-tips").html("请输入图形验证码");
              return false;
          }
          var _this = $(this);
          _this.attr("disabled","disabled");
          var safe_account = "{$info.user.safe_account}";
          var account = "";
          $(".ht-tips").html("");
          switch(safe_account){
              case "tel":
                  account = "{$info.user.tel_safe}";
                  sendSms(account,_this);
              break;
              case "mail":
                  account = "{$info.user.mail_safe}";
                  sendEmail(account,_this);
              break;
              case "all":
                  account = "{$info.user.tel_safe}"
                  sendSms(account,_this);
              break;
          }
      });

      $(".ht-yes a").click(function(event) {
          $(".ht-tips").html("");
          $(".focus").removeClass('focus');
          var _this = $(this);
          if(!App.validate.run($("input[name=password]").val())){
              $("input[name=password]").addClass('focus');
              $("input[name=password]").focus();
              $(".ht-tips").html("请填写您的新密码");
              return false;
          }

          if(!App.validate.run($("input[name=password]").val().length,"length",6)){
              $("input[name=password]").addClass('focus');
              $("input[name=password]").focus();
              $(".ht-tips").html("密码长度至少6位");
              return false;
          }

          if(!App.validate.run($("input[name=password]").val(),"blend")){
              $("input[name=password]").addClass('focus');
              $("input[name=password]").focus();
              $(".ht-tips").html("请不要填写纯数字/纯字母");
              return false;
          }

          if($("input[name=password]").val() != $("input[name=confirmpassword]").val()){
              $("input[name=password]").addClass('focus');
              $("input[name=password]").focus();
              $(".ht-tips").html("两次密码不一致!");
              return false;
          }

          if(!App.validate.run($("input[name=code]").val())){
              $("input[name=code]").addClass('focus');
              $("input[name=code]").focus();
              $(".ht-tips").html("请填写您的验证码");
              return false;
          }
          var safe_account = "{$info.user.safe_account}";
          var account = "";
          if(safe_account == "mail"){
            account = "{$info.user.mail_safe}";
          }else{
             account = "{$info.user.tel_safe}";
          }

          $.ajax({
              url: "/verifysmscode/",
              type: 'POST',
              dataType : "JSON",
              data: {
                  code: $("input[name=code]").val(),
                  tel:account,
                  cookie:$(".order_safecode").val()
              },
              success: function(data) {
                  if (data.status == 1) {
                      editpassword(_this);
                  }else{
                      //显示提示
                      $(".ht-tips").html(data.info);
                  }
              },
              error: function(xhr) {
                  $(".ht-tips").html("提交失败,请稍后再试！");
              }
          });
      });

      function editpassword(target){
        $.ajax({
                type : "POST",
                url : "/orderchange/",
                dataType : "JSON",
                data:{
                    password:$("input[name=password]").val(),
                    comfirmpassword:$("input[name=password]").val()
                },
                success:function(data){
                    if(data.status == 1){
                        target.attr("disabled",false);
                        $(".ht-tips").html("密码修改成功");
                        $("#myForm")[0].reset();
                    }else{
                        $(".ht-tips").html(data.info);
                    }
                },
                error:function(xhr){
                    target.attr("disabled",false);
                    $(".ht-tips").html("发生了未知的错误,请刷新再试！");
                }
            });
      }

      function sendSms(tel,target){
            var data = {
                tel:tel,
                code:$(".compinfo-secret input[name=verifyCode]").val(),
                save:0
            }

            $.ajax({
                type : "POST",
                url : "/sendsms/",
                dataType : "json",
                data:data,
                success : function(data){
                    if(data.status == 0){
                        target.attr("disabled",false);
                        $(".ht-tips").html(data.info);
                    }else{
                        if(data.status == 9){
                          target.attr("disabled",false);
                            $(".compinfo-secret input[name=verifyCode]").addClass('focus').focus().parent().find(".err-tips").html("图形验证码不正确");
                        }
                        if(data.status == 1){
                            alert('验证码发送成功');
                        }
                        if(data.data != null){
                          $(".order_safecode").val(data.data.name+"="+data.data.value + "&expires=" +data.data.expires);
                        }
                    }
                },
                error:function(xhr){
                    target.attr("disabled",false);
                    $(".ht-tips").html("发送失败,请稍后再试！");
                }
            });
        }

        function sendEmail(mail,target){
             var data = {
                    email:mail,
                    code:$(".compinfo-secret input[name=verifyCode]").val()
                }
                $.ajax({
                    type : "POST",
                    url : "/sendemail/",
                    dataType : "json",
                    data:data,
                    success : function(data){
                        if(data.status == 0){
                            target.attr("disabled",false);
                            $(".ht-tips").html(data.info);
                        }else{
                            if(data.data != ""){
                              $(".order_safecode").val(data.data.name+"="+data.data.value + "&expires=" +data.data.expires);
                            }
                        }
                    },
                    error:function(xhr){
                        target.attr("disabled",false);
                        $(".ht-tips").html("发送失败,请稍后再试！");
                    }
                });
        }
  });
</script>
</html>
