<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="keywords" content="{$keys.keywords}">
        <meta name="description" content="{$keys.description}">
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <title>{$keys.title}-{$title}</title>
        <include file="Index:resource" />
        <include file="Home:resource" />
        <link rel="stylesheet" href="{$static_host}/assets/user/home/css/ht-info.css?v={:C('STATIC_VERSION')}" />
        <link rel="stylesheet" href="{$static_host}/assets/user/companyinfo/css/branchstore.css?v={:C('STATIC_VERSION')}"/>
    </head>
    <body>
        <include file="Home:header" />
        <div class="ht-wrap oflow ht-relative">
            <include file="Home:comnavleft" />
            <include file="Companyinfo:tab_header" />
            <div class="ht-main">
                <!--
                    <volist name="list" id="vo">
                        <form action="" id="">
                            <h2>
                                分店{$i}
                            </h2>
                            <ul class="moreshops">
                                <li>
                                    <span>
                                        分店名称：
                                    </span>
                                    <input name="shortname" type="text" placeholder="分店名称" value="{$vo.shortname}"
                                    />
                                    <i class="gray ml20">
                                        如：吴江分店，相城二部
                                    </i>
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        排序：
                                    </span>
                                    <input name="seq" type="text" placeholder="排序" value="{$vo.seq}" onkeyup="this.value=this.value.replace(/\D/g,'')"
                                    onafterpaste="this.value=this.value.replace(/\D/g,'')">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        分店全称：
                                    </span>
                                    <input name="subname" type="text" placeholder="分店全称" value="{$vo.subname}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        地址：
                                    </span>
                                    <input class="full" name="addr" type="text" placeholder="地址" value="{$vo.addr}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        联系电话：
                                    </span>
                                    <input name="tel" type="text" placeholder="联系电话" value="{$vo.tel}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        手机：
                                    </span>
                                    <input name="mobile" type="text" placeholder="手机" value="{$vo.mobile}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        客服QQ1：
                                    </span>
                                    <input class="mr20" name="nickname" type="text" placeholder="客服昵称1" value="{$vo.nickname}"
                                    />
                                    <input name="qq" type="text" placeholder="客服qq1" value="{$vo.qq}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <span>
                                        客服QQ2：
                                    </span>
                                    <input class="mr20" name="nickname1" type="text" placeholder="客服昵称2" value="{$vo.nickname1}"
                                    />
                                    <input name="qq1" type="text" placeholder="客服qq2" value="{$vo.qq1}">
                                    <i class="red err-tips">
                                    </i>
                                </li>
                                <li>
                                    <input type="hidden" name="id" value="{$vo.id}">
                                    <a class="del" href="javascript:;" storeid="{$vo.id}" style="padding: 7px 18px;">
                                        <i class="icon-trash mr10">
                                        </i>
                                        删除该分店
                                    </a>
                                    <div class="ht-yes" style="float:left;padding:0px;">
                                        <a href="javascript:;">
                                            <i class="icon-ok mr10">
                                            </i>
                                            保存资料
                                        </a>
                                    </div>
                                </li>
                            </ul>
                        </form>
                    </volist>
                -->
                <!--当前分店-->
                <volist name="list" id="vo">
                <div class="fd" style="display:none" data-id="{$vo.id}">
                    <form action="" id="">
                        <h2 class="fd-tit">编辑分店</h2>
                        <ul class="moreshops">
                            <li>
                                <span>
                                    分店名称：
                                </span>
                                <input class="in-focus" name="shortname" type="text" value="{$vo.shortname}" data-focus="请输入分店简称" /> (简称尽量简洁)
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    分店全称：
                                </span>
                                <input class="in-focus" name="subname" type="text" value="{$vo.subname}" data-focus="请输入分店全称" />
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    排序：
                                </span>
                                <input class="in-focus" name="seq" type="text" value="{$vo.seq}" data-focus="请输入序号" > (数字越小，排序越靠前)
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    手机号码：
                                </span>
                                <input class="in-focus" name="mobile" type="text" placeholder="手机" value="{$vo.mobile}" data-focus="请输入11位手机号" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    固定电话：
                                </span>
                                <input class="in-focus" name="tel" type="text" placeholder="联系电话" value="{$vo.tel}" data-focus="请按照XXXX-XXXXXXX格式输入" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    详细地址：
                                </span>
                                <input class="full in-focus" name="addr" type="text" placeholder="地址" value="{$vo.addr}" data-focus="请填写地址" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    客服QQ1：
                                </span>
                                <input class="mr20" name="nickname" type="text" placeholder="昵称" value="{$vo.nickname}"  />
                                <input  class="in-focus" name="qq" type="text" placeholder="号码" value="{$vo.qq}" data-focus="请填写正确的QQ" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    客服QQ2：
                                </span>
                                <input class="mr20" name="nickname1" type="text" placeholder="昵称" value="{$vo.nickname1}"/>
                                <input class="in-focus" name="qq1" type="text" placeholder="号码" value="{$vo.qq1}" data-focus="请填写正确的QQ" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <input type="hidden" name="id" value="{$vo.id}">
                                <div class="ht-yes">
                                    <a href="javascript:;">保存</a>
                                </div>
                            </li>
                        </ul>
                    </form>
                </div>
                </volist>
                <!--新增分店-->
                <div class="new-fd" style="display:none">
                    <form>
                        <h2 class="fd-tit">添加分店</h2>
                        <ul class="moreshops">
                            <li>
                                <span>
                                    分店名称：
                                </span>
                                <input class="in-focus" name="shortname" type="text" data-focus="请输入分店简称" /> (简称尽量简洁)
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <span>
                                    分店全称：
                                </span>
                                <input class="in-focus" name="subname" type="text" data-focus="请输入分店全称" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    排序：
                                </span>
                                <input class="in-focus" name="seq" type="text" data-focus="请输入序号" /> (数字越小，排序越靠前)
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <span>
                                    手机号码：
                                </span>
                                <input class="in-focus" name="mobile" type="text" data-focus="请输入11位手机号" >
                                <i class="red err-tips">
                                </i>
                            </li>
                            <li>
                                <span>
                                    固定电话：
                                </span>
                                <input class="in-focus" name="tel" type="text" placeholder="格式:XXXX-XXXXXXX" data-focus="请按照XXXX-XXXXXXX格式输入" >
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <span>
                                    详细地址：
                                </span>
                                <input class="full in-focus" name="addr" type="text"  data-focus="请填写地址" >
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <span>
                                    客服QQ1：
                                </span>
                                <input class="mr20" value="" name="nickname" type="text" placeholder="昵称"/>
                                <input value="" class="in-focus" name="qq" type="text" placeholder="号码" data-focus="请填写正确的QQ" >
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <span>
                                    客服QQ2：
                                </span>
                                <input class="mr20" value="" name="nickname1" type="text" placeholder="昵称"/>
                                <input value="" class="in-focus" name="qq1" type="text" placeholder="号码" data-focus="请填写正确的QQ" >
                                <i class="red err-tips"></i>
                            </li>
                            <li>
                                <div class="ht-yes">
                                    <a href="javascript:;">保存</a>
                                </div>
                            </li>
                        </ul>
                    </form>
                </div>

                <!--分店1-->
                <div class="c-fend-box">
                    <div class="c-fend-tit">
                        分店管理
                    </div>
                    <volist name="list" id="vo">
                        <div class="c-fend-list">
                            <ul class="c-fend-list-ul">
                                <li class="c-fend-list-tit">
                                    {$vo.shortname}
                                </li>
                                <li>
                                    分店全称：{$vo.subname}
                                </li>
                                <li>
                                    联系电话：{$vo.tel}
                                </li>
                                <li>
                                    手机：{$vo.mobile}
                                </li>
                                <li>
                                    排序：{$vo.seq}
                                </li>
                                <li>
                                    客服QQ1：{$vo.nickname}
                                </li>
                                <li>
                                    客服QQ2：{$vo.nickname1}
                                </li>
                            </ul>
                            <div class="c-fend-list-btn">
                                <button class="c-fend-edit" type="button">
                                    <i class="icon-pencil" data-id="{$vo.id}">
                                    </i>
                                    修改
                                </button>
                                <button class="del" type="button" storeid="{$vo.id}">
                                    <i class="icon-trash">
                                    </i>
                                    删除
                                </button>
                            </div>
                        </div>
                    </volist>
                    <div class="c-fend-add" title="新增分店">
                        <i class="icon-plus">
                        </i>
                    </div>
                </div>
                <!--分店最多五个-->
            </div>
        </div>
        <include file="Index:footer" />
        <script type="text/javascript">
            $(function() {
                //点击保存后触发的事件
                //这玩意写的太死了，要改
                function operate(){
                    $(".ht-yes").click(function(event) {
                        /* 点击保存的时候 */
                        $(".err-tips").html(""); //将所有提示恢复初始化
                        var shortname_obj = $(this).parent().parent().find("input[name='shortname']");
                        var seq_obj = $(this).parent().parent().find("input[name='seq']");
                        var subname_obj = $(this).parent().parent().find("input[name='subname']");
                        var addr_obj = $(this).parent().parent().find("input[name='addr']");
                        var tel_obj = $(this).parent().parent().find("input[name='tel']");
                        var mobile_obj = $(this).parent().parent().find("input[name='mobile']");
                        var qq_obj = $(this).parent().parent().find("input[name='qq']");
                        var qq1_obj = $(this).parent().parent().find("input[name='qq1']");
                        if (!App.validate.run(shortname_obj.val())) {
                            shortname_obj.focus();
                            var content = shortname_obj.attr('data-focus');
                            shortname_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (!App.validate.run(seq_obj.val())) {
                            seq_obj.focus();
                            var content = seq_obj.attr('data-focus');
                            seq_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (!App.validate.run(subname_obj.val())) {
                            subname_obj.focus();
                            var content = subname_obj.attr('data-focus');
                            subname_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (!App.validate.run(addr_obj.val())) {
                            addr_obj.focus();
                            var content = addr_obj.attr('data-focus');
                            addr_obj.parent().find(".err-tips").html(content);
                            return false;
                        };

                        if (!App.validate.run(tel_obj.val(), "tel")) {
                            tel_obj.focus();
                            var content = tel_obj.attr('data-focus');
                            tel_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (!App.validate.run(mobile_obj.val(), "moblie")) {
                            mobile_obj.focus();
                            var content = mobile_obj.attr('data-focus');
                            mobile_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (!App.validate.run(qq_obj.val(), "num")) {
                            qq_obj.focus();
                            var content = qq_obj.attr('data-focus');
                            qq_obj.parent().find(".err-tips").html(content);
                            return false;
                        };
                        if (qq1_obj.val() != "") {
                            if (!App.validate.run(qq1_obj.val(), "num")) {
                                qq1_obj.focus();
                                var content = qq1_obj.attr('data-focus');
                                qq1_obj.parent().find(".err-tips").html(content);
                                return false;
                            };
                        }
                        var json = $(this).parent().parent().parent().serializeArray();
                        $.post('/info/save_store', json,
                        function(res) {
                            if (res.info != "Ok") {
                                alert(res.data);
                            } else {
                                window.location.href = window.location.href;
                            }
                        },
                        'json');
                    });
                }

                //点击删除后触发的事件
                $(".del").click(function(event) {
                    var _this = this;
                    openwindow("确定删除该分店吗？",function(){
                        var id = $(_this).attr("storeid");
                        $.post("/info/del_store", {
                            id: id
                        },
                        function(res) {
                            if (res.info != "Ok") {
                                alert(res.data);
                            } else {
                                window.location.href = window.location.href;
                            }
                        },
                        'json');
                    });
                });

                function bindblur(){
                    $('.c-windowbg .in-focus').blur(function(event) {
                    var content = $(this).val();
                    if(!content){
                        $(this).parent().find(".err-tips").html($(this).attr('data-focus'));
                        $(this).css("border","1px solid #F15858");
                    }else{
                        var name = $(this).attr('name');
                        if('mobile' == name){
                            var reg = new RegExp("^[0-9]{11}$");
                            if(!reg.test(content)){
                                $(this).parent().find(".err-tips").html($(this).attr('data-focus'));
                                return false;
                            }
                        }
                        if('seq' == name){
                            var reg = new RegExp("^[0-9]*$");
                            if(!reg.test(content)){
                                $(this).parent().find(".err-tips").html('请输入数字');
                                return false;
                            }
                        }
                        if('tel' == name){
                            var reg = new RegExp("^[0-9]{4}-[0-9]{8}$");
                            if(!reg.test(content)){
                                $(this).parent().find(".err-tips").html($(this).attr('data-focus'));
                                return false;
                            }
                        }
                        $(this).parent().find(".err-tips").empty();
                        $(this).css("border","1px solid #ccc");
                    }
                });
                }

                /*
                  *弹窗模版*
                  tagClass:触发的class
                  obj：弹窗内容
                  btnSub：提交时关闭
                  */
                function openmodel(tagClass, obj, btnSub) {
                    $(tagClass).on('click',
                        function() {
                            var thisid = $(this).find('i').attr('data-id');
                            var objMain = $("div[data-id='"+thisid+"']").html();
                            if(!objMain){
                                var objMain = $(obj).html();
                            }
                            $('body').append('<div class="c-windowbg"><div class="c-windowbox"><i class="shutdown icon-remove"></i>' + objMain + '</div></div>');

                            $('.c-windowbg').find('.shutdown').on('click',
                            function() {
                                $('.c-windowbg').remove();
                            });

                            bindblur();

                            $(btnSub).on('click',
                            function() {
                                $(".ht-yes").unbind('click');
                                operate();
                                /*
                                    if(表单验证=true){
                                    $('.c-windowbg').remove();
                                    }
                                */
                                //之所以没有跟上面合并是因为避免没出现未验证情况而导致直接关闭，
                            });
                        });
                };
                //修改分店
                openmodel('.c-fend-edit', '.fd', '.ht-yes a');
                //新增分店
                openmodel('.c-fend-add', '.new-fd', '.ht-yes a');
            });
        </script>
    </body>
</html>